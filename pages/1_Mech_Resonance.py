import streamlit as st
import numpy as np
import plotly.graph_objects as go
from scipy.integrate import solve_ivp

# –û–±–≥–æ—Ä—Ç–∞—î–º–æ –í–°–ï –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑ —Ä–∞–º–∫–æ—é
with st.container(border=True):
    st.title("üìà –í–∏–º—É—à–µ–Ω—ñ –∫–æ–ª–∏–≤–∞–Ω–Ω—è —Ç–∞ –†–µ–∑–æ–Ω–∞–Ω—Å")
    st.write("–ú–æ–¥–µ–ª—å –æ—Å—Ü–∏–ª—è—Ç–æ—Ä–∞ –∑ –∑–∞—Ç—É—Ö–∞–Ω–Ω—è–º —Ç–∞ –∑–æ–≤–Ω—ñ—à–Ω—å–æ—é —Å–∏–Ω—É—Å–æ—ó–¥–∞–ª—å–Ω–æ—é —Å–∏–ª–æ—é.")

    # --- –ü–ê–†–ê–ú–ï–¢–†–ò –ü–ï–†–ï–ú–Ü–©–ï–ù–û –°–Æ–î–ò ---
    st.subheader("–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ —Å–∏–º—É–ª—è—Ü—ñ—ó")
    col1, col2, col3 = st.columns(3)
    
    with col1:
        m = st.slider("–ú–∞—Å–∞ (m), –∫–≥", 0.1, 10.0, 1.0, key="res_m")
        F0 = st.slider("–ê–º–ø–ª—ñ—Ç—É–¥–∞ —Å–∏–ª–∏ (F‚ÇÄ), –ù", 0.0, 50.0, 10.0, key="res_F0")
    with col2:
        k = st.slider("–ñ–æ—Ä—Å—Ç–∫—ñ—Å—Ç—å –ø—Ä—É–∂–∏–Ω–∏ (k), –ù/–º", 0.1, 50.0, 10.0, key="res_k")
        omega_d = st.slider("–ß–∞—Å—Ç–æ—Ç–∞ —Å–∏–ª–∏ (œâ_d), —Ä–∞–¥/—Å", 0.1, 10.0, 3.0, 0.1, key="res_wd")
    with col3:
        b = st.slider("–ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –∑–∞—Ç—É—Ö–∞–Ω–Ω—è (b)", 0.0, 5.0, 0.5, key="res_b")
        t_max = st.slider("–ß–∞—Å —Å–∏–º—É–ª—è—Ü—ñ—ó (T), —Å", 10.0, 200.0, 50.0, key="res_tmax")
    
    st.divider() # –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞ –ª—ñ–Ω—ñ—è

    # --- –ë–õ–û–ö –¢–ï–û–†–Ü–á ---
    with st.expander("üìñ –í—ñ–¥–∫—Ä–∏—Ç–∏ —Ç–µ–æ—Ä—ñ—é —Ç–∞ —Ñ–æ—Ä–º—É–ª–∏", expanded=False):
        st.subheader("–î–∏—Ñ–µ—Ä–µ–Ω—Ü—ñ–∞–ª—å–Ω–µ —Ä—ñ–≤–Ω—è–Ω–Ω—è")
        st.write("–†—ñ–≤–Ω—è–Ω–Ω—è –≤–∏–º—É—à–µ–Ω–∏—Ö –∫–æ–ª–∏–≤–∞–Ω—å:")
        st.latex(r"m \ddot{x} + b \dot{x} + k x = F_0 \cos(\omega_d t)")
        st.markdown("""
        * $F_0$ ‚Äî –∞–º–ø–ª—ñ—Ç—É–¥–∞ –∑–æ–≤–Ω—ñ—à–Ω—å–æ—ó —Å–∏–ª–∏
        * $\omega_d$ ‚Äî —á–∞—Å—Ç–æ—Ç–∞ –∑–æ–≤–Ω—ñ—à–Ω—å–æ—ó —Å–∏–ª–∏
        """)
        st.write("–†–æ–∑–≤'—è–∑–æ–∫ —Å–∫–ª–∞–¥–∞—î—Ç—å—Å—è –∑ –¥–≤–æ—Ö —á–∞—Å—Ç–∏–Ω: –ø–µ—Ä–µ—Ö—ñ–¥–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É (—â–æ –∑–≥–∞—Å–∞—î) —Ç–∞ —É—Å—Ç–∞–ª–µ–Ω–∏—Ö –∫–æ–ª–∏–≤–∞–Ω—å (–∑ —á–∞—Å—Ç–æ—Ç–æ—é $\omega_d$).")
        
        st.subheader("–†–µ–∑–æ–Ω–∞–Ω—Å")
        st.markdown("–ê–º–ø–ª—ñ—Ç—É–¥–∞ —É—Å—Ç–∞–ª–µ–Ω–∏—Ö –∫–æ–ª–∏–≤–∞–Ω—å `A` –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —á–∞—Å—Ç–æ—Ç–∏:")
        st.latex(r"A(\omega_d) = \frac{F_0/m}{\sqrt{(\omega_0^2 - \omega_d^2)^2 + (b\omega_d/m)^2}}")
        
        st.markdown(r"–¥–µ $\omega_0 = \sqrt{k/m}$ - –≤–ª–∞—Å–Ω–∞ —á–∞—Å—Ç–æ—Ç–∞. –ê–º–ø–ª—ñ—Ç—É–¥–∞ `A` —Å—Ç–∞—î –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—é, –∫–æ–ª–∏ $\omega_d \approx \omega_0$. –¶–µ —è–≤–∏—â–µ –Ω–∞–∑–∏–≤–∞—î—Ç—å—Å—è **—Ä–µ–∑–æ–Ω–∞–Ω—Å–æ–º**.")

    # --- –†–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–≤–∞ —á–∞—Å—Ç–∏–Ω–∞ ---
    omega0 = np.sqrt(k / m)
    omega_res = 0.0
    if (b/(2*m))**2 < omega0**2:
        omega_res = np.sqrt(omega0**2 - (b/(2*m))**2)

    st.subheader("–ö–ª—é—á–æ–≤—ñ —á–∞—Å—Ç–æ—Ç–∏ —Å–∏—Å—Ç–µ–º–∏")
    col1, col2 = st.columns(2)
    col1.metric("–í–ª–∞—Å–Ω–∞ —á–∞—Å—Ç–æ—Ç–∞ (œâ‚ÇÄ)", f"{omega0:.3f} —Ä–∞–¥/—Å")
    col2.metric("–†–µ–∑–æ–Ω–∞–Ω—Å–Ω–∞ —á–∞—Å—Ç–æ—Ç–∞ (œâ_res)", f"{omega_res:.3f} —Ä–∞–¥/—Å", 
                help="–ß–∞—Å—Ç–æ—Ç–∞, –Ω–∞ —è–∫—ñ–π –∞–º–ø–ª—ñ—Ç—É–¥–∞ –±—É–¥–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—é.")

    if np.isclose(omega_d, omega_res, atol=0.1) and b < 1.0:
        st.success("–í–∏ –≤ –∑–æ–Ω—ñ —Ä–µ–∑–æ–Ω–∞–Ω—Å—É! –ê–º–ø–ª—ñ—Ç—É–¥–∞ –º–∞—î —Ä—ñ–∑–∫–æ –∑—Ä–æ—Å—Ç–∞—Ç–∏.")

    def model(t, y):
        x, v = y
        dxdt = v
        dvdt = (F0 * np.cos(omega_d * t) - b * v - k * x) / m
        return [dxdt, dvdt]

    y0 = [0, 0]
    t_span = [0, t_max]
    t_eval = np.linspace(t_span[0], t_span[1], 1000)
    sol = solve_ivp(model, t_span, y0, t_eval=t_eval)
    x_values = sol.y[0]
    t_values = sol.t

    # --- –ì—Ä–∞—Ñ—ñ–∫ ---
    st.header("–ì—Ä–∞—Ñ—ñ–∫ —Ä—É—Ö—É x(t)")
    st.write("–°–ø—Ä–æ–±—É–π—Ç–µ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ '–ß–∞—Å—Ç–æ—Ç—É —Å–∏–ª–∏' (œâ_d) —Ä—ñ–≤–Ω–æ—é '–†–µ–∑–æ–Ω–∞–Ω—Å–Ω—ñ–π —á–∞—Å—Ç–æ—Ç—ñ' (œâ_res).")

    fig = go.Figure()
    fig.add_trace(go.Scatter(x=t_values, y=x_values, mode='lines', name='–ó–º—ñ—â–µ–Ω–Ω—è (x)'))
    fig.update_layout(
        title="–ó–∞–ª–µ–∂–Ω—ñ—Å—Ç—å –∑–º—ñ—â–µ–Ω–Ω—è –≤—ñ–¥ —á–∞—Å—É x(t)",
        xaxis_title="–ß–∞—Å (t), —Å",
        yaxis_title="–ó–º—ñ—â–µ–Ω–Ω—è (x), –º"
    )

    steady_state_amplitude = np.max(np.abs(x_values[int(len(x_values) * 2/3):]))
    st.metric("–£—Å—Ç–∞–ª–µ–Ω–∞ –∞–º–ø–ª—ñ—Ç—É–¥–∞", f"{steady_state_amplitude:.3f} –º",
              help="–ú–∞–∫—Å. –∞–º–ø–ª—ñ—Ç—É–¥–∞ –ø—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –ø–µ—Ä–µ—Ö—ñ–¥–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É (–≤ –æ—Å—Ç–∞–Ω–Ω—ñ–π —Ç—Ä–µ—Ç–∏–Ω—ñ —á–∞—Å—É).")
    
    st.plotly_chart(fig, use_container_width=True)