import streamlit as st
import numpy as np
import plotly.graph_objects as go
import scipy.constants as const

with st.container(border=True):
    st.title("üëª –ö–≤–∞–Ω—Ç–æ–≤–µ —Ç—É–Ω–µ–ª—é–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ –±–∞—Ä'—î—Ä")
    st.write("–í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è —Ö–≤–∏–ª—å–æ–≤–æ—ó —Ñ—É–Ω–∫—Ü—ñ—ó —á–∞—Å—Ç–∏–Ω–∫–∏, —â–æ –Ω–∞–ª—ñ—Ç–∞—î –Ω–∞ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –±–∞—Ä'—î—Ä.")

    # --- –ü–ê–†–ê–ú–ï–¢–†–ò –ü–ï–†–ï–ú–Ü–©–ï–ù–û –ó –ë–Ü–ß–ù–û–á –ü–ê–ù–ï–õ–Ü ---
    st.subheader("–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ —Å–∏–º—É–ª—è—Ü—ñ—ó")
    
    col1, col2 = st.columns(2)
    with col1:
        E_eV = st.slider("–ï–Ω–µ—Ä–≥—ñ—è —á–∞—Å—Ç–∏–Ω–∫–∏ (E), –µ–í", 0.1, 10.0, 5.0, 0.1, key="tun_E")
        L_pm = st.slider("–®–∏—Ä–∏–Ω–∞ –±–∞—Ä'—î—Ä—É (L), –ø–º", 10, 200, 50, 5, key="tun_L")

    with col2:
        # V0_eV –º–∞—î –±—É—Ç–∏ –±—ñ–ª—å—à–∏–º –∑–∞ E_eV
        V0_min = E_eV + 0.1
        V0_initial = max(V0_min, 10.0) # –ó–∞–±–µ–∑–ø–µ—á—É—î–º–æ, —â–æ –ø–æ—á–∞—Ç–∫–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è –Ω–µ –º–µ–Ω—à–µ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ–≥–æ
        V0_eV = st.slider("–í–∏—Å–æ—Ç–∞ –±–∞—Ä'—î—Ä—É (V‚ÇÄ), –µ–í", V0_min, 20.0, V0_initial, 0.1,
                          key="tun_V0", help="V‚ÇÄ –º–∞—î –±—É—Ç–∏ –±—ñ–ª—å—à–∏–º –∑–∞ E –¥–ª—è —Ç—É–Ω–µ–ª—é–≤–∞–Ω–Ω—è.")

    st.divider()
    # --- –ö–Ü–ù–ï–¶–¨ –ü–ï–†–ï–ú–Ü–©–ï–ù–ù–Ø –ü–ê–†–ê–ú–ï–¢–†–Ü–í ---

    # --- –ë–õ–û–ö –¢–ï–û–†–Ü–á ---
    with st.expander("üìñ –í—ñ–¥–∫—Ä–∏—Ç–∏ —Ç–µ–æ—Ä—ñ—é —Ç–∞ —Ñ–æ—Ä–º—É–ª–∏", expanded=False):
        st.subheader("–¢—É–Ω–µ–ª—å–Ω–∏–π –µ—Ñ–µ–∫—Ç")
        st.write("–£ –∫–ª–∞—Å–∏—á–Ω—ñ–π —Ñ—ñ–∑–∏—Ü—ñ —á–∞—Å—Ç–∏–Ω–∫–∞ –∑ –µ–Ω–µ—Ä–≥—ñ—î—é $E$ –Ω–µ –º–æ–∂–µ –ø—Ä–æ–π—Ç–∏ –∫—Ä—ñ–∑—å –±–∞—Ä'—î—Ä –∑ –≤–∏—Å–æ—Ç–æ—é $V_0 > E$.")
        st.write("–£ –∫–≤–∞–Ω—Ç–æ–≤—ñ–π –º–µ—Ö–∞–Ω—ñ—Ü—ñ —Ö–≤–∏–ª—å–æ–≤–∞ —Ñ—É–Ω–∫—Ü—ñ—è —á–∞—Å—Ç–∏–Ω–∫–∏ $\Psi$ –Ω–µ –¥–æ—Ä—ñ–≤–Ω—é—î –Ω—É–ª—é –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –±–∞—Ä'—î—Ä—É (–≤–æ–Ω–∞ –µ–∫—Å–ø–æ–Ω–µ–Ω—Ü—ñ–π–Ω–æ –∑–∞—Ç—É—Ö–∞—î). –Ø–∫—â–æ –±–∞—Ä'—î—Ä –¥–æ—Å—Ç–∞—Ç–Ω—å–æ —Ç–æ–Ω–∫–∏–π, —ñ—Å–Ω—É—î –Ω–µ–Ω—É–ª—å–æ–≤–∞ –π–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å, —â–æ —á–∞—Å—Ç–∏–Ω–∫–∞ \"–ø—Ä–æ—Å–æ—á–∏—Ç—å—Å—è\" –∫—Ä—ñ–∑—å –Ω—å–æ–≥–æ.")
        st.subheader("–ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è (T)")
        st.write("–ô–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å —Ç—É–Ω–µ–ª—é–≤–∞–Ω–Ω—è (–¥–ª—è $E < V_0$) —Ç–æ—á–Ω–æ –æ–ø–∏—Å—É—î—Ç—å—Å—è —è–∫:")
        st.latex(r"T = \left[ 1 + \frac{V_0^2}{4 E (V_0 - E)} \sinh^2(\kappa L) \right]^{-1}")
        st.write("–¥–µ $\kappa$ (–∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –∑–∞—Ç—É—Ö–∞–Ω–Ω—è) –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —Ä—ñ–∑–Ω–∏—Ü—ñ –µ–Ω–µ—Ä–≥—ñ–π:")
        st.latex(r"\kappa = \frac{\sqrt{2m(V_0 - E)}}{\hbar}")

    # --- –†–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–≤–∞ —á–∞—Å—Ç–∏–Ω–∞ ---
    m = const.electron_mass
    E = E_eV * const.electron_volt
    V0 = V0_eV * const.electron_volt
    L = L_pm * 1e-12
    hbar = const.hbar

    kappa = np.sqrt(2 * m * (V0 - E)) / hbar

    # –¢–æ—á–Ω–∞ —Ñ–æ—Ä–º—É–ª–∞ –¥–ª—è –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∞ –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è (T)
    numerator = V0**2
    denominator_part = 4 * E * (V0 - E)
    
    # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ np.sinh –¥–ª—è –≥—ñ–ø–µ—Ä–±–æ–ª—ñ—á–Ω–æ–≥–æ —Å–∏–Ω—É—Å–∞
    T_inv = 1 + (numerator / denominator_part) * (np.sinh(kappa * L)**2)
    T = 1.0 / T_inv

    st.header("–ô–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å —Ç—É–Ω–µ–ª—é–≤–∞–Ω–Ω—è")
    st.metric("–ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è (T)", f"{T:.3e}",
              help="–ô–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å —Ç–æ–≥–æ, —â–æ —á–∞—Å—Ç–∏–Ω–∫–∞ –ø—Ä–æ–π–¥–µ –∫—Ä—ñ–∑—å –±–∞—Ä'—î—Ä.")

    # --- –ì—Ä–∞—Ñ—ñ–∫ ---
    st.header("–í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è —Ö–≤–∏–ª—å–æ–≤–æ—ó —Ñ—É–Ω–∫—Ü—ñ—ó (Re[Œ®])")
    
    k1 = np.sqrt(2 * m * E) / hbar

    x_left = np.linspace(-L*2, 0, 100)
    x_barrier = np.linspace(0, L, 50)
    x_right = np.linspace(L, L*3, 100)

    # –ü—Ä–∏–±–ª–∏–∑–Ω—ñ –∞–º–ø–ª—ñ—Ç—É–¥–∏ –¥–ª—è –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó
    A_in = 1.0 # –í—Ö—ñ–¥–Ω–∞ —Ö–≤–∏–ª—è
    A_trans = np.sqrt(T) # –•–≤–∏–ª—è, —â–æ –ø—Ä–æ–π—à–ª–∞
    A_refl = np.sqrt(1 - T) # –í—ñ–¥–±–∏—Ç–∞ —Ö–≤–∏–ª—è

    # –°–ø—Ä–æ—â–µ–Ω–∞ —Ñ–æ—Ä–º–∞ —Ö–≤–∏–ª—å–æ–≤–æ—ó —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó
    psi_left = A_in * np.cos(k1 * x_left) - A_refl * np.cos(k1 * x_left) # –°–ø—Ä–æ—â–µ–Ω–∞ —Å—Ç–æ—è—á–∞ —Ö–≤–∏–ª—è
    psi_barrier = A_in * np.exp(-kappa * x_barrier) * (0.5 * (1+np.sqrt(T)))
    psi_right = A_trans * np.cos(k1 * (x_right - L))

    x_plot = np.concatenate((x_left, x_barrier, x_right)) * 1e12
    psi_plot = np.concatenate((psi_left, psi_barrier, psi_right))

    fig = go.Figure()
    
    # –•–≤–∏–ª—å–æ–≤–∞ —Ñ—É–Ω–∫—Ü—ñ—è
    fig.add_trace(go.Scatter(x=x_plot, y=psi_plot, mode='lines', name='Re[Œ®(x)]',
                              line=dict(color='blue', width=3)))
    
    # –ë–∞—Ä'—î—Ä (Potencial V(x))
    # –ú–∞–ª—é—î–º–æ –±–∞—Ä'—î—Ä –Ω–∞ —Ä—ñ–≤–Ω—ñ V0_eV, –∞ —Ö–≤–∏–ª—å–æ–≤—É —Ñ—É–Ω–∫—Ü—ñ—é –Ω–∞ —É–º–æ–≤–Ω–æ–º—É —Ä—ñ–≤–Ω—ñ 0.
    # –î–ª—è –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó —Ö–≤–∏–ª—ñ –Ω–∞–¥ –±–∞—Ä'—î—Ä–æ–º –º–∏ –ø—Ä–æ—Å—Ç–æ –º–∞—Å—à—Ç–∞–±—É—î–º–æ —ó—ó.
    V_scale = np.max(np.abs(psi_plot)) / V0_eV
    
    # –§–æ–Ω –±–∞—Ä'—î—Ä–∞
    fig.add_shape(type="rect",
        x0=0, y0=V0_eV * 0.0, x1=L_pm, y1=V0_eV * 1.5,
        line=dict(color="red", width=2, dash='dot'),
        fillcolor="rgba(255, 0, 0, 0.1)",
        layer="below"
    )
    
    # –†—ñ–≤–µ–Ω—å –µ–Ω–µ—Ä–≥—ñ—ó E
    fig.add_trace(go.Scatter(x=[np.min(x_plot), np.max(x_plot)], y=[0, 0],
                              mode='lines', line=dict(color='green', width=2, dash='dash'),
                              name='–†—ñ–≤–µ–Ω—å –µ–Ω–µ—Ä–≥—ñ—ó E'))
    
    fig.update_layout(
        title="–†–µ–∞–ª—å–Ω–∞ —á–∞—Å—Ç–∏–Ω–∞ —Ö–≤–∏–ª—å–æ–≤–æ—ó —Ñ—É–Ω–∫—Ü—ñ—ó (—Å–ø—Ä–æ—â–µ–Ω–∞ –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è)",
        xaxis_title="–ü–æ–∑–∏—Ü—ñ—è (x), –ø–º",
        yaxis_title="–ê–º–ø–ª—ñ—Ç—É–¥–∞ (—É–º–æ–≤–Ω—ñ –æ–¥–∏–Ω–∏—Ü—ñ)",
        legend=dict(orientation="h", yanchor="bottom", y=1.02, xanchor="right", x=1)
    )
    st.plotly_chart(fig, use_container_width=True)