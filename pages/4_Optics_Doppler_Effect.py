import streamlit as st
import numpy as np
import plotly.graph_objects as go
import scipy.constants as const

# --- –§—ñ–∑–∏—á–Ω—ñ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∏ ---
c = const.c # –®–≤–∏–¥–∫—ñ—Å—Ç—å —Å–≤—ñ—Ç–ª–∞ (–º/—Å)

# --- –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∫–æ–ª—å–æ—Ä—É (—Ç–∞ —Å–∞–º–∞, —â–æ –π —Ä–∞–Ω—ñ—à–µ) ---
def wavelength_to_hex(nm):
    gamma = 0.8
    intensity_max = 255
    factor = 0.0
    R, G, B = 0, 0, 0
    if 380 <= nm <= 439:
        R = -(nm - 440) / (440 - 380); G = 0.0; B = 1.0
    elif 440 <= nm <= 489:
        R = 0.0; G = (nm - 440) / (490 - 440); B = 1.0
    elif 490 <= nm <= 509:
        R = 0.0; G = 1.0; B = -(nm - 510) / (510 - 490)
    elif 510 <= nm <= 579:
        R = (nm - 510) / (580 - 510); G = 1.0; B = 0.0
    elif 580 <= nm <= 644:
        R = 1.0; G = -(nm - 645) / (645 - 580); B = 0.0
    elif 645 <= nm <= 780:
        R = 1.0; G = 0.0; B = 0.0
    if 380 <= nm <= 419:
        factor = 0.3 + 0.7 * (nm - 380) / (420 - 380)
    elif 420 <= nm <= 644:
        factor = 1.0
    elif 645 <= nm <= 780:
        factor = 0.3 + 0.7 * (780 - nm) / (780 - 645)
    else:
        factor = 0.0
    R = int(intensity_max * (R * factor)**gamma)
    G = int(intensity_max * (G * factor)**gamma)
    B = int(intensity_max * (B * factor)**gamma)
    return f'#{R:02x}{G:02x}{B:02x}'

# --- –û—Å–Ω–æ–≤–Ω–∞ —á–∞—Å—Ç–∏–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–∏ ---
with st.container(border=True):
    st.title("üöë –ï—Ñ–µ–∫—Ç –î–æ–ø–ª–µ—Ä–∞ (–¥–ª—è —Å–≤—ñ—Ç–ª–∞)")
    st.write("–°–∏–º—É–ª—è—Ü—ñ—è –ø–æ–∫–∞–∑—É—î, —è–∫ –∑–º—ñ–Ω—é—î—Ç—å—Å—è –¥–æ–≤–∂–∏–Ω–∞ —Ö–≤–∏–ª—ñ (–∫–æ–ª—ñ—Ä) —Å–≤—ñ—Ç–ª–∞, —è–∫–µ –±–∞—á–∏—Ç—å —Å–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—á, —á–µ—Ä–µ–∑ –≤—ñ–¥–Ω–æ—Å–Ω–∏–π —Ä—É—Ö.")

    # --- –ü–ê–†–ê–ú–ï–¢–†–ò –°–ò–ú–£–õ–Ø–¶–Ü–á ---
    st.subheader("–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ —Å–∏–º—É–ª—è—Ü—ñ—ó")
    
    col1, col2 = st.columns(2)
    with col1:
        lambda_source_nm = st.slider(
            "–î–æ–≤–∂–∏–Ω–∞ —Ö–≤–∏–ª—ñ –¥–∂–µ—Ä–µ–ª–∞ (Œª‚ÇÄ), –Ω–º", 
            min_value=400, max_value=700, value=550, step=10,
            key="dop_lambda", help="–°–ø—Ä–∞–≤–∂–Ω—ñ–π –∫–æ–ª—ñ—Ä, —è–∫–∏–π –≤–∏–ø—Ä–æ–º—ñ–Ω—é—î –¥–∂–µ—Ä–µ–ª–æ.")
        
        # –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –æ–±—Ä–∞–Ω–æ–≥–æ –∫–æ–ª—å–æ—Ä—É
        color_hex_source = wavelength_to_hex(lambda_source_nm)
        st.markdown(f"**–ö–æ–ª—ñ—Ä –¥–∂–µ—Ä–µ–ª–∞:** <div style='width:100%; height:20px; background-color:{color_hex_source}; border: 1px solid white;'></div>", unsafe_allow_html=True)
        
    with col2:
        # v > 0: –¥–∂–µ—Ä–µ–ª–æ –≤—ñ–¥–¥–∞–ª—è—î—Ç—å—Å—è
        # v < 0: –¥–∂–µ—Ä–µ–ª–æ –Ω–∞–±–ª–∏–∂–∞—î—Ç—å—Å—è
        v_frac_c = st.slider(
            "–í—ñ–¥–Ω–æ—Å–Ω–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å (v/c)",
            min_value=-0.99, max_value=0.99, value=0.0, step=0.01,
            key="dop_v", help="–ß–∞—Å—Ç–∫–∞ –≤—ñ–¥ —à–≤–∏–¥–∫–æ—Å—Ç—ñ —Å–≤—ñ—Ç–ª–∞ 'c'. (+) = –≤—ñ–¥–¥–∞–ª–µ–Ω–Ω—è, (-) = –Ω–∞–±–ª–∏–∂–µ–Ω–Ω—è.")
    
    st.divider()

    # --- –ë–õ–û–ö –¢–ï–û–†–Ü–á (–í–ò–ü–†–ê–í–õ–ï–ù–û) ---
    with st.expander("üìñ –í—ñ–¥–∫—Ä–∏—Ç–∏ —Ç–µ–æ—Ä—ñ—é —Ç–∞ —Ñ–æ—Ä–º—É–ª–∏", expanded=False):
        st.subheader("–†–µ–ª—è—Ç–∏–≤—ñ—Å—Ç—Å—å–∫–∏–π –µ—Ñ–µ–∫—Ç –î–æ–ø–ª–µ—Ä–∞")
        st.write("–ö–æ–ª–∏ –¥–∂–µ—Ä–µ–ª–æ —Å–≤—ñ—Ç–ª–∞ —Ä—É—Ö–∞—î—Ç—å—Å—è –≤—ñ–¥–Ω–æ—Å–Ω–æ —Å–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—á–∞, –¥–æ–≤–∂–∏–Ω–∞ —Ö–≤–∏–ª—ñ, —è–∫—É '–±–∞—á–∏—Ç—å' —Å–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—á ($\\lambda$), –≤—ñ–¥—Ä—ñ–∑–Ω—è—î—Ç—å—Å—è –≤—ñ–¥ —Ç—ñ—î—ó, —è–∫—É –¥–∂–µ—Ä–µ–ª–æ –≤–∏–ø—Ä–æ–º—ñ–Ω—é—î ($\\lambda_0$).")
        st.write("–¢–æ—á–Ω–∞ —Ä–µ–ª—è—Ç–∏–≤—ñ—Å—Ç—Å—å–∫–∞ —Ñ–æ—Ä–º—É–ª–∞ (–¥–ª—è —Ä—É—Ö—É –≤–∑–¥–æ–≤–∂ –ª—ñ–Ω—ñ—ó –∑–æ—Ä—É):")
        
        # --- (–í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ r"..." -> "...") ---
        st.latex("\\lambda = \\lambda_0 \\sqrt{\\frac{1 + \\beta}{1 - \\beta}}")
        st.write("–¥–µ $\\beta = v/c$ ‚Äî –≤—ñ–¥–Ω–æ—Å–Ω–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å.")
        
        # --- (–†–æ–∑–¥—ñ–ª–µ–Ω–æ, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –ø–æ–º–∏–ª–∫–∏ –∑ \\beta) ---
        st.markdown("* **–î–∂–µ—Ä–µ–ª–æ –≤—ñ–¥–¥–∞–ª—è—î—Ç—å—Å—è ($v > 0 \implies \\beta > 0$):** –ó–Ω–∞–º–µ–Ω–Ω–∏–∫ –∑–º–µ–Ω—à—É—î—Ç—å—Å—è, —á–∏—Å–µ–ª—å–Ω–∏–∫ –∑–±—ñ–ª—å—à—É—î—Ç—å—Å—è. $\lambda > \lambda_0$. –¶–µ **–ß–µ—Ä–≤–æ–Ω–∏–π –∑—Å—É–≤** (Redshift).")
        st.markdown("* **–î–∂–µ—Ä–µ–ª–æ –Ω–∞–±–ª–∏–∂–∞—î—Ç—å—Å—è ($v < 0 \implies \\beta < 0$):** –ß–∏—Å–µ–ª—å–Ω–∏–∫ –∑–º–µ–Ω—à—É—î—Ç—å—Å—è, –∑–Ω–∞–º–µ–Ω–Ω–∏–∫ –∑–±—ñ–ª—å—à—É—î—Ç—å—Å—è. $\lambda < \lambda_0$. –¶–µ **–°–∏–Ω—ñ–π –∑—Å—É–≤** (Blueshift).")
        # --- –ö–Ü–ù–ï–¶–¨ –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø ---
        
        st.info("–¶—è —Å–∏–º—É–ª—è—Ü—ñ—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –ø–æ–≤–Ω—É —Ä–µ–ª—è—Ç–∏–≤—ñ—Å—Ç—Å—å–∫—É —Ñ–æ—Ä–º—É–ª—É.")

    # --- –†–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–≤–∞ —á–∞—Å—Ç–∏–Ω–∞ ---
    
    beta = v_frac_c
    
    # –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –Ω–æ–≤–æ—ó –¥–æ–≤–∂–∏–Ω–∏ —Ö–≤–∏–ª—ñ
    lambda_observed_nm = lambda_source_nm * np.sqrt((1 + beta) / (1 - beta))
    
    # –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∑—Å—É–≤—É
    shift_nm = lambda_observed_nm - lambda_source_nm
    
    # –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ Z-–ø–∞—Ä–∞–º–µ—Ç—Ä–∞ (–∞—Å—Ç—Ä–æ—Ñ—ñ–∑–∏—á–Ω–∏–π —á–µ—Ä–≤–æ–Ω–∏–π –∑—Å—É–≤)
    z_factor = shift_nm / lambda_source_nm
    
    st.header("–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—É")
    col_res1, col_res2 = st.columns(2)
    
    col_res1.metric("–°–ø—Ä–∞–≤–∂–Ω—è –¥–æ–≤–∂–∏–Ω–∞ —Ö–≤–∏–ª—ñ (Œª‚ÇÄ)", f"{lambda_source_nm:.1f} –Ω–º")
    col_res2.metric("–°–ø–æ—Å—Ç–µ—Ä–µ–∂—É–≤–∞–Ω–∞ –¥–æ–≤–∂–∏–Ω–∞ —Ö–≤–∏–ª—ñ (Œª)", f"{lambda_observed_nm:.1f} –Ω–º",
                    delta=f"{shift_nm:.1f} –Ω–º", delta_color="normal")
                    
    st.metric("–ü–∞—Ä–∞–º–µ—Ç—Ä —á–µ—Ä–≤–æ–Ω–æ–≥–æ –∑—Å—É–≤—É (z)", f"{z_factor:.4f}",
              help="z = (Œª - Œª‚ÇÄ) / Œª‚ÇÄ. z > 0 (—á–µ—Ä–≤–æ–Ω–∏–π –∑—Å—É–≤), z < 0 (—Å–∏–Ω—ñ–π –∑—Å—É–≤)")

    # --- –ì—Ä–∞—Ñ—ñ–∫ ---
    st.header("–ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è —Å–ø–µ–∫—Ç—Ä—ñ–≤")
    
    # –°—Ç–≤–æ—Ä—é—î–º–æ "—Å–ø–µ–∫—Ç—Ä" - –ø—Ä–æ—Å—Ç–æ –ª—ñ–Ω—ñ—é
    intensity = [0, 1, 0]
    
    fig = go.Figure()
    
    # 1. –°–ø–µ–∫—Ç—Ä –î–∂–µ—Ä–µ–ª–∞ (Œª‚ÇÄ)
    fig.add_trace(go.Scatter(
        x=[lambda_source_nm-1, lambda_source_nm, lambda_source_nm+1], # –ú–∞–ª—é—î–º–æ –≤—É–∑—å–∫–∏–π –ø—ñ–∫
        y=intensity,
        mode='lines',
        name=f'–î–∂–µ—Ä–µ–ª–æ (Œª‚ÇÄ = {lambda_source_nm:.0f} –Ω–º)',
        line=dict(color=wavelength_to_hex(lambda_source_nm), width=4, dash='dot')
    ))

    # 2. –°–ø–µ–∫—Ç—Ä –°–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—á–∞ (Œª)
    fig.add_trace(go.Scatter(
        x=[lambda_observed_nm-1, lambda_observed_nm, lambda_observed_nm+1], # –ú–∞–ª—é—î–º–æ –≤—É–∑—å–∫–∏–π –ø—ñ–∫
        y=intensity,
        mode='lines',
        name=f'–°–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—á (Œª = {lambda_observed_nm:.0f} –Ω–º)',
        line=dict(color=wavelength_to_hex(lambda_observed_nm), width=4)
    ))
    
    # 3. –î–æ–¥–∞—î–º–æ —Ñ–æ–Ω –¥–ª—è –≤–∏–¥–∏–º–æ–≥–æ —Å–ø–µ–∫—Ç—Ä—É (–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ 'add_shape')
    fig.add_shape(
        type="rect",
        x0=400, y0=0, x1=700, y1=1.1, # y1=1.1 (—Ç—Ä–æ—Ö–∏ –≤–∏—â–µ)
        fillcolor="rgba(100, 100, 100, 0.2)", line_width=0,
        layer="below"
    )
    fig.add_annotation(
        x=550, y=0.5, text="–í–∏–¥–∏–º–∏–π —Å–ø–µ–∫—Ç—Ä", textangle=-90,
        showarrow=False, opacity=0.3
    )

    fig.update_layout(
        title="–ó—Å—É–≤ —Å–ø–µ–∫—Ç—Ä–∞–ª—å–Ω–æ—ó –ª—ñ–Ω—ñ—ó —á–µ—Ä–µ–∑ –ï—Ñ–µ–∫—Ç –î–æ–ø–ª–µ—Ä–∞",
        xaxis_title="–î–æ–≤–∂–∏–Ω–∞ —Ö–≤–∏–ª—ñ (Œª), –Ω–º",
        yaxis_title="–Ü–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ñ—Å—Ç—å (—É–º–æ–≤–Ω–∞)",
        xaxis_range=[min(300, lambda_source_nm*0.8, lambda_observed_nm*0.8), 
                     max(800, lambda_source_nm*1.2, lambda_observed_nm*1.2)], # –î–∏–Ω–∞–º—ñ—á–Ω–∏–π –¥—ñ–∞–ø–∞–∑–æ–Ω
        yaxis_range=[-0.1, 1.1], # –¢—Ä–æ—Ö–∏ –º—ñ—Å—Ü—è –∑–Ω–∏–∑—É
        height=400
    )
    st.plotly_chart(fig, use_container_width=True)