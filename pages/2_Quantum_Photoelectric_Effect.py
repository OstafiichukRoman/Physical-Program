import streamlit as st
import numpy as np
import plotly.graph_objects as go
import scipy.constants as const

# --- –§—ñ–∑–∏—á–Ω—ñ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∏ ---
h_eVs = const.physical_constants['Planck constant in eV s'][0] # h –≤ –µ–í¬∑—Å
c = const.c # —à–≤–∏–¥–∫—ñ—Å—Ç—å —Å–≤—ñ—Ç–ª–∞
e = const.e # –∑–∞—Ä—è–¥ –µ–ª–µ–∫—Ç—Ä–æ–Ω–∞

# --- –°–ª–æ–≤–Ω–∏–∫ –∑ —Ä–æ–±–æ—Ç–∞–º–∏ –≤–∏—Ö–æ–¥—É –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö –º–µ—Ç–∞–ª—ñ–≤ (–≤ –µ–í) ---
work_functions = {
    "–¶–µ–∑—ñ–π (Cs)": 2.14,
    "–ö–∞–ª—ñ–π (K)": 2.30,
    "–ù–∞—Ç—Ä—ñ–π (Na)": 2.75,
    "–¶–∏–Ω–∫ (Zn)": 4.31,
    "–ü–ª–∞—Ç–∏–Ω–∞ (Pt)": 6.35,
    "–í–ª–∞—Å–Ω–∏–π –º–µ—Ç–∞–ª": 5.0 
}

# --- –û—Å–Ω–æ–≤–Ω–∞ —á–∞—Å—Ç–∏–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–∏ ---
with st.container(border=True):
    st.title("üí° –§–æ—Ç–æ–µ–ª–µ–∫—Ç—Ä–∏—á–Ω–∏–π –µ—Ñ–µ–∫—Ç")
    st.write("–°–∏–º—É–ª—è—Ü—ñ—è –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—É, —â–æ –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î –∫–≤–∞–Ω—Ç–æ–≤—É –ø—Ä–∏—Ä–æ–¥—É —Å–≤—ñ—Ç–ª–∞ (—Ñ–æ—Ç–æ–Ω–∏).")

    # --- –ü–ê–†–ê–ú–ï–¢–†–ò –°–ò–ú–£–õ–Ø–¶–Ü–á (–Ω–∞ –≥–æ–ª–æ–≤–Ω—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ) ---
    st.subheader("–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—É")
    
    col1, col2 = st.columns(2)
    with col1:
        # –û–±–∏—Ä–∞—î–º–æ –º–µ—Ç–∞–ª (—Ä–æ–±–æ—Ç—É –≤–∏—Ö–æ–¥—É)
        metal = st.selectbox(
            "–û–±–µ—Ä—ñ—Ç—å –º–∞—Ç–µ—Ä—ñ–∞–ª –∫–∞—Ç–æ–¥–∞:",
            options=list(work_functions.keys()),
            key="photo_metal"
        )
        
        if metal == "–í–ª–∞—Å–Ω–∏–π –º–µ—Ç–∞–ª":
            Phi_eV = st.slider(
                "–†–æ–±–æ—Ç–∞ –≤–∏—Ö–æ–¥—É (Œ¶), –µ–í", 
                min_value=1.0, max_value=7.0, value=5.0, step=0.01,
                key="photo_phi_slider"
            )
        else:
            Phi_eV = work_functions[metal]
            st.metric("–†–æ–±–æ—Ç–∞ –≤–∏—Ö–æ–¥—É (Œ¶)", f"{Phi_eV} –µ–í")
            
    with col2:
        # –û–±–∏—Ä–∞—î–º–æ –¥–æ–≤–∂–∏–Ω—É —Ö–≤–∏–ª—ñ
        lambda_nm = st.slider(
            "–î–æ–≤–∂–∏–Ω–∞ —Ö–≤–∏–ª—ñ —Å–≤—ñ—Ç–ª–∞ (Œª), –Ω–º",
            min_value=100, max_value=1000, value=300, step=10,
            key="photo_lambda", help="100 (–£–§) ... 700 (–ß–µ—Ä–≤–æ–Ω–µ)"
        )
        
        # –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –µ–Ω–µ—Ä–≥—ñ—ó —Ñ–æ—Ç–æ–Ω–∞
        # E = hc/lambda
        E_photon_eV = (h_eVs * c) / (lambda_nm * 1e-9)
        st.metric("–ï–Ω–µ—Ä–≥—ñ—è —Ñ–æ—Ç–æ–Ω–∞ (E)", f"{E_photon_eV:.2f} –µ–í")
        
    st.divider()

    # --- –ë–õ–û–ö –¢–ï–û–†–Ü–á ---
    with st.expander("üìñ –í—ñ–¥–∫—Ä–∏—Ç–∏ —Ç–µ–æ—Ä—ñ—é —Ç–∞ —Ñ–æ—Ä–º—É–ª–∏", expanded=False):
        st.subheader("–†—ñ–≤–Ω—è–Ω–Ω—è –ï–π–Ω—à—Ç–µ–π–Ω–∞ –¥–ª—è —Ñ–æ—Ç–æ–µ—Ñ–µ–∫—Ç—É (1905)")
        st.write("–ï–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –ø–æ–∫–∞–∑–∞–≤, —â–æ:")
        st.markdown("""
        1.  –ï–ª–µ–∫—Ç—Ä–æ–Ω–∏ "–≤–∏–±–∏–≤–∞—é—Ç—å—Å—è" –∑ –º–µ—Ç–∞–ª—É —Å–≤—ñ—Ç–ª–æ–º **–º–∏—Ç—Ç—î–≤–æ**.
        2.  –ï–Ω–µ—Ä–≥—ñ—è –µ–ª–µ–∫—Ç—Ä–æ–Ω—ñ–≤ **–Ω–µ –∑–∞–ª–µ–∂–∏—Ç—å** –≤—ñ–¥ *—ñ–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—ñ* (—è—Å–∫—Ä–∞–≤–æ—Å—Ç—ñ) —Å–≤—ñ—Ç–ª–∞.
        3.  –ï–Ω–µ—Ä–≥—ñ—è –µ–ª–µ–∫—Ç—Ä–æ–Ω—ñ–≤ **–∑–∞–ª–µ–∂–∏—Ç—å** –≤—ñ–¥ *—á–∞—Å—Ç–æ—Ç–∏* (–∫–æ–ª—å–æ—Ä—É) —Å–≤—ñ—Ç–ª–∞.
        4.  –Ü—Å–Ω—É—î "—á–µ—Ä–≤–æ–Ω–∞ –º–µ–∂–∞" ‚Äî –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ —á–∞—Å—Ç–æ—Ç–∞, –Ω–∏–∂—á–µ —è–∫–æ—ó –µ—Ñ–µ–∫—Ç –Ω–µ —Å–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è.
        """)
        st.write("–ï–π–Ω—à—Ç–µ–π–Ω –ø–æ—è—Å–Ω–∏–≤ —Ü–µ, –ø—Ä–∏–ø—É—Å—Ç–∏–≤—à–∏, —â–æ —Å–≤—ñ—Ç–ª–æ —Å–∫–ª–∞–¥–∞—î—Ç—å—Å—è –∑ —á–∞—Å—Ç–∏–Ω–æ–∫ (—Ñ–æ—Ç–æ–Ω—ñ–≤) –∑ –µ–Ω–µ—Ä–≥—ñ—î—é $E = h\nu$.")
        
        # --- –û–°–¨ –¢–£–¢ –ë–£–õ–ê –ü–û–ú–ò–õ–ö–ê, –¢–ï–ü–ï–† –í–ò–ü–†–ê–í–õ–ï–ù–û ---
        # (–ó–∞–º—ñ–Ω–µ–Ω–æ st.write –Ω–∞ st.markdown —ñ "–≤–∏—Ä–≤–∞—Ç–∏" –≤–∑—è—Ç–æ –≤ –æ–¥–∏–Ω–∞—Ä–Ω—ñ –ª–∞–ø–∫–∏)
        st.markdown("–§–æ—Ç–æ–Ω –ø–µ—Ä–µ–¥–∞—î **–≤—Å—é** —Å–≤–æ—é –µ–Ω–µ—Ä–≥—ñ—é –µ–ª–µ–∫—Ç—Ä–æ–Ω—É. –©–æ–± '–≤–∏—Ä–≤–∞—Ç–∏' –µ–ª–µ–∫—Ç—Ä–æ–Ω –∑ –º–µ—Ç–∞–ª—É, –ø–æ—Ç—Ä—ñ–±–Ω–∞ –µ–Ω–µ—Ä–≥—ñ—è $\Phi$ (—Ä–æ–±–æ—Ç–∞ –≤–∏—Ö–æ–¥—É). –ó–∞–ª–∏—à–æ–∫ –µ–Ω–µ—Ä–≥—ñ—ó –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å —É –∫—ñ–Ω–µ—Ç–∏—á–Ω—É –µ–Ω–µ—Ä–≥—ñ—é –µ–ª–µ–∫—Ç—Ä–æ–Ω–∞ $K_{max}$:")
        # --- –ö–Ü–ù–ï–¶–¨ –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø ---
        
        st.latex(r"K_{max} = E_{—Ñ–æ—Ç–æ–Ω–∞} - \Phi = h\nu - \Phi")
        st.write("–Ø–∫—â–æ $E_{—Ñ–æ—Ç–æ–Ω–∞} < \Phi$, –µ–ª–µ–∫—Ç—Ä–æ–Ω–∏ –Ω–µ –≤–∏–ª—ñ—Ç–∞—é—Ç—å.")
        
    # --- –†–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–≤–∞ —á–∞—Å—Ç–∏–Ω–∞ ---
    
    # –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∫—ñ–Ω–µ—Ç–∏—á–Ω–æ—ó –µ–Ω–µ—Ä–≥—ñ—ó
    K_max_eV = E_photon_eV - Phi_eV
    
    st.header("–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—É")
    
    if K_max_eV > 0:
        # –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∑–∞—Ç—Ä–∏–º—É—é—á–æ—ó –Ω–∞–ø—Ä—É–≥–∏ (V_stop = K_max / e)
        V_stop = K_max_eV # –û—Å–∫—ñ–ª—å–∫–∏ K_max –≤ –µ–í, –∞ V_stop –≤ –í–æ–ª—å—Ç–∞—Ö, –≤–æ–Ω–∏ —á–∏—Å–µ–ª—å–Ω–æ —Ä—ñ–≤–Ω—ñ
        st.success(f"**–§–æ—Ç–æ–µ—Ñ–µ–∫—Ç —Å–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è!**")
        st.metric("–ú–∞–∫—Å. –∫—ñ–Ω–µ—Ç–∏—á–Ω–∞ –µ–Ω–µ—Ä–≥—ñ—è (K_max)", f"{K_max_eV:.2f} –µ–í")
        st.metric("–ó–∞—Ç—Ä–∏–º—É—é—á–∞ –Ω–∞–ø—Ä—É–≥–∞ (V_stop)", f"{V_stop:.2f} –í")
    else:
        st.error(f"**–§–æ—Ç–æ–µ—Ñ–µ–∫—Ç –ù–ï —Å–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è.**")
        st.metric("–ú–∞–∫—Å. –∫—ñ–Ω–µ—Ç–∏—á–Ω–∞ –µ–Ω–µ—Ä–≥—ñ—è (K_max)", "0.00 –µ–í")
        st.write(f"–ï–Ω–µ—Ä–≥—ñ—è —Ñ–æ—Ç–æ–Ω–∞ ({E_photon_eV:.2f} –µ–í) **–º–µ–Ω—à–∞** –∑–∞ —Ä–æ–±–æ—Ç—É –≤–∏—Ö–æ–¥—É ({Phi_eV} –µ–í).")

    # --- –ì—Ä–∞—Ñ—ñ–∫ K_max(E_photon) ---
    st.header("–ì—Ä–∞—Ñ—ñ–∫ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ K_max –≤—ñ–¥ –ï–Ω–µ—Ä–≥—ñ—ó —Ñ–æ—Ç–æ–Ω–∞")
    
    # –°—Ç–≤–æ—Ä—é—î–º–æ –¥—ñ–∞–ø–∞–∑–æ–Ω –µ–Ω–µ—Ä–≥—ñ–π —Ñ–æ—Ç–æ–Ω—ñ–≤
    E_photon_range_eV = np.linspace(0, 10, 200) # –≤—ñ–¥ 0 –¥–æ 10 –µ–í
    
    # –†–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ K_max –¥–ª—è –∫–æ–∂–Ω–æ—ó –µ–Ω–µ—Ä–≥—ñ—ó
    K_max_range_eV = E_photon_range_eV - Phi_eV
    
    # –í—Å–µ, —â–æ –Ω–∏–∂—á–µ 0, –Ω–∞—Å–ø—Ä–∞–≤–¥—ñ —î 0 (–µ–ª–µ–∫—Ç—Ä–æ–Ω–∏ –Ω–µ –≤–∏–ª—ñ—Ç–∞—é—Ç—å)
    K_max_range_eV[K_max_range_eV < 0] = 0
    
    fig = go.Figure()

    # –ú–∞–ª—é—î–º–æ –≥—Ä–∞—Ñ—ñ–∫ K_max(E)
    fig.add_trace(go.Scatter(
        x=E_photon_range_eV, 
        y=K_max_range_eV,
        mode='lines',
        name='K_max = E - Œ¶',
        line=dict(color='blue', width=4)
    ))
    
    # –ú–∞–ª—é—î–º–æ "–ø–æ—Ä—ñ–≥" (—Ä–æ–±–æ—Ç—É –≤–∏—Ö–æ–¥—É)
    # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ 'add_shape' (—Å—Ç–∞—Ä–∏–π, –Ω–∞–¥—ñ–π–Ω–∏–π –º–µ—Ç–æ–¥)
    fig.add_shape(
        type="line",
        x0=Phi_eV, y0=0, x1=Phi_eV, y1=max(K_max_range_eV),
        line=dict(color="red", width=2, dash="dot")
    )
    fig.add_annotation(
        x=Phi_eV, y=max(K_max_range_eV)*0.9, 
        text=f"–ß–µ—Ä–≤–æ–Ω–∞ –º–µ–∂–∞ Œ¶ = {Phi_eV:.2f} –µ–í", 
        showarrow=True, arrowhead=1, ax=20, ay=-30
    )
                  
    # –ú–∞–ª—é—î–º–æ –ø–æ—Ç–æ—á–Ω—É —Ç–æ—á–∫—É –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—É
    fig.add_trace(go.Scatter(
        x=[E_photon_eV],
        y=[K_max_eV if K_max_eV > 0 else 0],
        mode='markers',
        marker=dict(color='red', size=15, symbol='x'),
        name=f'–ü–æ—Ç–æ—á–Ω–∏–π –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç (Œª={lambda_nm} –Ω–º)'
    ))
    
    fig.update_layout(
        title=f"–ó–∞–ª–µ–∂–Ω—ñ—Å—Ç—å K_max –≤—ñ–¥ –µ–Ω–µ—Ä–≥—ñ—ó —Ñ–æ—Ç–æ–Ω–∞ –¥–ª—è '{metal}'",
        xaxis_title="–ï–Ω–µ—Ä–≥—ñ—è —Ñ–æ—Ç–æ–Ω–∞ (E = hŒΩ), –µ–í",
        yaxis_title="–ú–∞–∫—Å. –ö—ñ–Ω–µ—Ç–∏—á–Ω–∞ –ï–Ω–µ—Ä–≥—ñ—è (K_max), –µ–í",
        xaxis_range=[0, 10],
        yaxis_range=[-0.5, 10 - Phi_eV + 0.5]
    )
    st.plotly_chart(fig, use_container_width=True)