import streamlit as st
import numpy as np
import plotly.graph_objects as go
from scipy.fft import fft, fftfreq, fftshift
import scipy.constants as const

with st.container(border=True):
    st.title("üåä –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ç–æ—Ä –ø—Ä–∏–Ω—Ü–∏–ø—É –Ω–µ–≤–∏–∑–Ω–∞—á–µ–Ω–æ—Å—Ç—ñ")
    st.write("–ü–æ–∫–∞–∑—É—î –∑–≤'—è–∑–æ–∫ –º—ñ–∂ –ø–æ–ª–æ–∂–µ–Ω–Ω—è–º (Œîx) —Ç–∞ —ñ–º–ø—É–ª—å—Å–æ–º (Œîp) —á–∞—Å—Ç–∏–Ω–∫–∏.")

    # --- –ü–ê–†–ê–ú–ï–¢–†–ò –ü–ï–†–ï–ú–Ü–©–ï–ù–û –ó –ë–Ü–ß–ù–û–á –ü–ê–ù–ï–õ–Ü ---
    st.subheader("–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ —Å–∏–º—É–ª—è—Ü—ñ—ó")
    
    col_param, _ = st.columns([1, 2])
    with col_param:
        delta_x_pm = st.slider(
            "–ù–µ–≤–∏–∑–Ω–∞—á–µ–Ω—ñ—Å—Ç—å –ø–æ–ª–æ–∂–µ–Ω–Ω—è (Œîx), –ø–º", 
            1.0, 100.0, 20.0, 1.0, 
            key="unc_dx", 
            help="–ß–∏–º –º–µ–Ω—à–µ Œîx, —Ç–∏–º —Ç–æ—á–Ω—ñ—à–µ –≤—ñ–¥–æ–º–µ –ø–æ–ª–æ–∂–µ–Ω–Ω—è, –∞–ª–µ —Ç–∏–º –º–µ–Ω—à –≤—ñ–¥–æ–º–∏–π —ñ–º–ø—É–ª—å—Å."
        )
    
    st.divider()
    # --- –ö–Ü–ù–ï–¶–¨ –ü–ï–†–ï–ú–Ü–©–ï–ù–ù–Ø –ü–ê–†–ê–ú–ï–¢–†–Ü–í ---

    # --- –ë–õ–û–ö –¢–ï–û–†–Ü–á ---
    with st.expander("üìñ –í—ñ–¥–∫—Ä–∏—Ç–∏ —Ç–µ–æ—Ä—ñ—é —Ç–∞ —Ñ–æ—Ä–º—É–ª–∏", expanded=False):
        st.subheader("–°–ø—ñ–≤–≤—ñ–¥–Ω–æ—à–µ–Ω–Ω—è –ì–µ–π–∑–µ–Ω–±–µ—Ä–≥–∞")
        st.write("–§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω–∏–π –ø—Ä–∏–Ω—Ü–∏–ø –∫–≤–∞–Ω—Ç–æ–≤–æ—ó –º–µ—Ö–∞–Ω—ñ–∫–∏ —Å—Ç–≤–µ—Ä–¥–∂—É—î, —â–æ –Ω–µ–º–æ–∂–ª–∏–≤–æ –æ–¥–Ω–æ—á–∞—Å–Ω–æ –∑ –¥–æ–≤—ñ–ª—å–Ω–æ—é —Ç–æ—á–Ω—ñ—Å—Ç—é –≤–∏–º—ñ—Ä—è—Ç–∏ –ø–æ–ª–æ–∂–µ–Ω–Ω—è ($x$) —Ç–∞ —ñ–º–ø—É–ª—å—Å ($p_x$) —á–∞—Å—Ç–∏–Ω–∫–∏.")
        st.latex(r"\Delta x \cdot \Delta p_x \geq \frac{\hbar}{2}")
        st.write("–¥–µ $\Delta x$ —Ç–∞ $\Delta p_x$ ‚Äî —Ü–µ –Ω–µ–≤–∏–∑–Ω–∞—á–µ–Ω–æ—Å—Ç—ñ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è) –≤–∏–º—ñ—Ä—é–≤–∞–Ω—å.")
        st.subheader("–•–≤–∏–ª—å–æ–≤—ñ –ø–∞–∫–µ—Ç–∏ —Ç–∞ –ü–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –§—É—Ä'—î")
        st.write("–ß–∞—Å—Ç–∏–Ω–∫–∞ —É –∫–≤–∞–Ω—Ç–æ–≤—ñ–π –º–µ—Ö–∞–Ω—ñ—Ü—ñ –æ–ø–∏—Å—É—î—Ç—å—Å—è —Ö–≤–∏–ª—å–æ–≤–æ—é —Ñ—É–Ω–∫—Ü—ñ—î—é $\Psi(x)$. –á—ó \"–≤–∏–≥–ª—è–¥\" –≤ —ñ–º–ø—É–ª—å—Å–Ω–æ–º—É –ø—Ä–æ—Å—Ç–æ—Ä—ñ, $\Phi(p)$, –ø–æ–≤'—è–∑–∞–Ω–∏–π –∑ $\Psi(x)$ —á–µ—Ä–µ–∑ **–ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –§—É—Ä'—î**.")
        st.write("–ß–∏–º **–≤—É–∂—á–∏–π** —Ö–≤–∏–ª—å–æ–≤–∏–π –ø–∞–∫–µ—Ç –≤ –ø—Ä–æ—Å—Ç–æ—Ä—ñ (–º–∞–ª–µ $\Delta x$), —Ç–∏–º **—à–∏—Ä—à–∏–π** –≤—ñ–Ω –≤ —ñ–º–ø—É–ª—å—Å–Ω–æ–º—É –ø—Ä–æ—Å—Ç–æ—Ä—ñ (–≤–µ–ª–∏–∫–µ $\Delta p$), —ñ –Ω–∞–≤–ø–∞–∫–∏. –¶–µ–π —Å–∏–º—É–ª—è—Ç–æ—Ä –≤—ñ–∑—É–∞–ª—ñ–∑—É—î —Ü–µ–π –∑–≤'—è–∑–æ–∫.")

    # --- –†–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–≤–∞ —á–∞—Å—Ç–∏–Ω–∞ ---
    delta_x = delta_x_pm * 1e-12 # –ü–µ—Ä–µ–≤–æ–¥–∏–º–æ –ø–º –≤ –º
    
    N = 2048
    x_max = delta_x * 50
    x = np.linspace(-x_max, x_max, N)
    
    # –•–≤–∏–ª—å–æ–≤–∞ —Ñ—É–Ω–∫—Ü—ñ—è (–ø—Ä–∏–ø—É—Å–∫–∞—î–º–æ –ì–∞—É—Å—Å—ñ–≤ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –ø–∞–∫–µ—Ç)
    # Psi(x) = exp(-x^2 / (4*delta_x^2))
    psi_x = np.exp(-x**2 / (4 * delta_x**2))
    
    # |Psi(x)|¬≤ (–ì—É—Å—Ç–∏–Ω–∞ –π–º–æ–≤—ñ—Ä–Ω–æ—Å—Ç—ñ –≤ x-–ø—Ä–æ—Å—Ç–æ—Ä—ñ)
    psi_x_sq = np.abs(psi_x)**2
    psi_x_sq = psi_x_sq / np.sum(psi_x_sq) # –ù–æ—Ä–º—É—î–º–æ
    
    # |Phi(p)|¬≤ (–ì—É—Å—Ç–∏–Ω–∞ –π–º–æ–≤—ñ—Ä–Ω–æ—Å—Ç—ñ –≤ p-–ø—Ä–æ—Å—Ç–æ—Ä—ñ)
    # –§—É—Ä'—î-–æ–±—Ä–∞–∑ –≤—ñ–¥ Psi(x) –¥–∞—î Phi(k) –∞–±–æ Phi(p)
    psi_k = fft(psi_x) 
    psi_k_sq = np.abs(psi_k)**2
    
    dx = x[1] - x[0]
    k = fftfreq(N, d=dx) * 2 * np.pi # –•–≤–∏–ª—å–æ–≤–µ —á–∏—Å–ª–æ k = 2*pi / lambda
    p = const.hbar * k # –Ü–º–ø—É–ª—å—Å p = hbar * k
    
    # –ó—Å—É–≤–∞—î–º–æ, —â–æ–± –Ω—É–ª—å–æ–≤–∏–π —ñ–º–ø—É–ª—å—Å –±—É–≤ —É —Ü–µ–Ω—Ç—Ä—ñ
    p_shifted = fftshift(p)
    psi_k_sq_shifted = fftshift(psi_k_sq)
    psi_k_sq_shifted = psi_k_sq_shifted / np.sum(psi_k_sq_shifted) # –ù–æ—Ä–º—É—î–º–æ
    
    # –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –Ω–µ–≤–∏–∑–Ω–∞—á–µ–Ω–æ—Å—Ç–µ–π (–¥–ª—è –ì–∞—É—Å—Å–æ–≤–æ–≥–æ –ø–∞–∫–µ—Ç—É —Å–ø—ñ–≤–≤—ñ–¥–Ω–æ—à–µ–Ω–Ω—è —Ç–æ—á–Ω–µ: Œîx*Œîp = ƒß/2)
    delta_p_calc = const.hbar / (2 * delta_x)
    product = delta_x * delta_p_calc
    hbar_2 = const.hbar / 2

    # --- –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è ---
    st.header("–¢–µ–æ—Ä–µ—Ç–∏—á–Ω—ñ –Ω–µ–≤–∏–∑–Ω–∞—á–µ–Ω–æ—Å—Ç—ñ (–¥–ª—è –ì–∞—É—Å—Å–æ–≤–æ–≥–æ –ø–∞–∫–µ—Ç—É)")
    col1, col2 = st.columns(2)
    col1.metric("–ó–∞–¥–∞–Ω–∞ –Ω–µ–≤–∏–∑–Ω–∞—á–µ–Ω—ñ—Å—Ç—å (Œîx)", f"{delta_x_pm:.1f} –ø–º")
    col2.metric("–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ (Œîp)", f"{delta_p_calc:.2e} –∫–≥¬∑–º/—Å")

    st.subheader("–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–ø—ñ–≤–≤—ñ–¥–Ω–æ—à–µ–Ω–Ω—è –ì–µ–π–∑–µ–Ω–±–µ—Ä–≥–∞")
    st.metric(f"–î–æ–±—É—Ç–æ–∫ (Œîx ¬∑ Œîp)", f"{product:.2e}", help=f"–¢–æ—á–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è –ì–∞—É—Å—Å–æ–≤–æ–≥–æ –ø–∞–∫–µ—Ç—É")
    st.metric(f"–¢–µ–æ—Ä–µ—Ç–∏—á–Ω–∏–π –º—ñ–Ω—ñ–º—É–º (ƒß/2)", f"{hbar_2:.2e}")
    st.success("–°–ø—ñ–≤–≤—ñ–¥–Ω–æ—à–µ–Ω–Ω—è –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è! (Œîx ¬∑ Œîp = ƒß/2)")

    st.info("–°–ø—Ä–æ–±—É–π—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏ Œîx: —è–∫—â–æ –ø–∞–∫–µ—Ç '–≤—É–∑—å–∫–∏–π' —É –ø—Ä–æ—Å—Ç–æ—Ä—ñ (–º–∞–ª–µ Œîx), –≤—ñ–Ω —Å—Ç–∞—î '—à–∏—Ä–æ–∫–∏–º' –≤ —ñ–º–ø—É–ª—å—Å—ñ (–≤–µ–ª–∏–∫–µ Œîp), —ñ –Ω–∞–≤–ø–∞–∫–∏.")

    # --- –ì—Ä–∞—Ñ—ñ–∫–∏ ---
    x_plot_pm = x * 1e12
    tab1, tab2 = st.tabs(["–ü—Ä–æ—Å—Ç—ñ—Ä –ø–æ–ª–æ–∂–µ–Ω—å |Œ®(x)|¬≤", "–ü—Ä–æ—Å—Ç—ñ—Ä —ñ–º–ø—É–ª—å—Å—ñ–≤ |Œ¶(p)|¬≤"])
    
    with tab1:
        st.subheader("–ì—É—Å—Ç–∏–Ω–∞ –π–º–æ–≤—ñ—Ä–Ω–æ—Å—Ç—ñ –≤ –ø—Ä–æ—Å—Ç–æ—Ä—ñ –ø–æ–ª–æ–∂–µ–Ω—å |Œ®(x)|¬≤")
        fig1 = go.Figure()
        fig1.add_trace(go.Scatter(x=x_plot_pm, y=psi_x_sq, mode='lines', 
                                  name='|Œ®(x)|¬≤', fill='tozeroy', line=dict(color='blue')))
        # –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è Œîx
        fig1.add_vline(x=-delta_x_pm, line_width=1, line_dash="dash", line_color="gray")
        fig1.add_vline(x=delta_x_pm, line_width=1, line_dash="dash", line_color="gray", 
                       annotation_text="Œîx", annotation_position="top right")
                       
        fig1.update_layout(xaxis_title="–ü–æ–ª–æ–∂–µ–Ω–Ω—è (x), –ø–º", yaxis_title="–ô–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å (—É–º–æ–≤–Ω—ñ –æ–¥–∏–Ω–∏—Ü—ñ)")
        fig1.update_xaxes(range=[-delta_x_pm * 5, delta_x_pm * 5])
        st.plotly_chart(fig1, use_container_width=True)

    with tab2:
        st.subheader("–ì—É—Å—Ç–∏–Ω–∞ –π–º–æ–≤—ñ—Ä–Ω–æ—Å—Ç—ñ –≤ –ø—Ä–æ—Å—Ç–æ—Ä—ñ —ñ–º–ø—É–ª—å—Å—ñ–≤ |Œ¶(p)|¬≤")
        fig2 = go.Figure()
        fig2.add_trace(go.Scatter(x=p_shifted, y=psi_k_sq_shifted, mode='lines', 
                                  line=dict(color='red'), name='|Œ¶(p)|¬≤', fill='tozeroy'))
        
        # –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è Œîp
        p_pm_range = delta_p_calc / (1e-12) # –ü—Ä–æ—Å—Ç–æ –¥–ª—è –≥–∞—Ä–Ω–æ–≥–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –º–∞—Å—à—Ç–∞–±—É
        fig2.add_vline(x=-delta_p_calc, line_width=1, line_dash="dash", line_color="gray")
        fig2.add_vline(x=delta_p_calc, line_width=1, line_dash="dash", line_color="gray",
                       annotation_text="Œîp", annotation_position="top right")
                       
        fig2.update_layout(xaxis_title="–Ü–º–ø—É–ª—å—Å (p), –∫–≥¬∑–º/—Å", yaxis_title="–ô–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å (—É–º–æ–≤–Ω—ñ –æ–¥–∏–Ω–∏—Ü—ñ)")
        p_plot_range = delta_p_calc * 10
        fig2.update_xaxes(range=[-p_plot_range, p_plot_range])
        st.plotly_chart(fig2, use_container_width=True)