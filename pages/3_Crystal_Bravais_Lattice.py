import streamlit as st
import numpy as np
import plotly.graph_objects as go

with st.container(border=True):
    st.title("üßä 3D-–í—ñ–∑—É–∞–ª—ñ–∑–∞—Ç–æ—Ä –∫—É–±—ñ—á–Ω–∏—Ö “ë—Ä–∞—Ç–æ–∫ –ë—Ä–∞–≤–µ")
    st.write("–ü–æ–∫–∞–∑—É—î —Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è –∞—Ç–æ–º—ñ–≤ —Ç–∞ —Ä–æ–∑—Ä–∞—Ö–æ–≤—É—î –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –ø–∞–∫—É–≤–∞–Ω–Ω—è.")

    # --- –ë–õ–û–ö –¢–ï–û–†–Ü–á ---
    with st.expander("üìñ –í—ñ–¥–∫—Ä–∏—Ç–∏ —Ç–µ–æ—Ä—ñ—é —Ç–∞ —Ñ–æ—Ä–º—É–ª–∏", expanded=False):
        st.subheader("–ö—É–±—ñ—á–Ω—ñ “ë—Ä–∞—Ç–∫–∏ –ë—Ä–∞–≤–µ")
        st.markdown("""
        –¶–µ —Ç—Ä–∏ –∑ 14 –º–æ–∂–ª–∏–≤–∏—Ö —Ç–∏–ø—ñ–≤ –∫—Ä–∏—Å—Ç–∞–ª—ñ—á–Ω–∏—Ö “ë—Ä–∞—Ç–æ–∫:
        1. **–ü—Ä–æ—Å—Ç–∞ –∫—É–±—ñ—á–Ω–∞ (–ü–ö):** –ê—Ç–æ–º–∏ –ª–∏—à–µ —É –≤–µ—Ä—à–∏–Ω–∞—Ö –∫—É–±–∞.
        2. **–û–±'—î–º–Ω–æ-—Ü–µ–Ω—Ç—Ä–æ–≤–∞–Ω–∞ (–û–¶–ö):** –ê—Ç–æ–º–∏ —É –≤–µ—Ä—à–∏–Ω–∞—Ö + –æ–¥–∏–Ω –∞—Ç–æ–º —É —Ü–µ–Ω—Ç—Ä—ñ –∫—É–±–∞.
        3. **–ì—Ä–∞ –Ω–µ-—Ü–µ–Ω—Ç—Ä–æ–≤–∞–Ω–∞ (–ì–¶–ö):** –ê—Ç–æ–º–∏ —É –≤–µ—Ä—à–∏–Ω–∞—Ö + –ø–æ –æ–¥–Ω–æ–º—É –∞—Ç–æ–º—É –≤ —Ü–µ–Ω—Ç—Ä—ñ –∫–æ–∂–Ω–æ—ó –∑ 6 –≥—Ä–∞–Ω–µ–π.
        """)
        st.subheader("–ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –ø–∞–∫—É–≤–∞–Ω–Ω—è (APF)")
        st.write("–ü–æ–∫–∞–∑—É—î, —è–∫–∞ —á–∞—Å—Ç–∏–Ω–∞ –æ–±'—î–º—É –µ–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω–æ—ó –∫–æ–º—ñ—Ä–∫–∏ –∑–∞–π–Ω—è—Ç–∞ –∞—Ç–æ–º–∞–º–∏ (–º–æ–¥–µ–ª—é—é—Ç—å—Å—è —è–∫ –∂–æ—Ä—Å—Ç–∫—ñ –∫—É–ª—ñ).")
        st.latex(r"APF = \frac{N_{atoms} \cdot V_{atom}}{V_{cell}}")
        
        # –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø–æ–º–∏–ª–∫–∏: –í–∏–Ω–æ—Å–∏–º–æ —Ñ–æ—Ä–º—É–ª—É –æ–±'—î–º—É –∞—Ç–æ–º–∞ –≤ –æ–∫—Ä–µ–º–∏–π st.latex –¥–ª—è –Ω–∞–¥—ñ–π–Ω–æ–≥–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
        st.latex(r"V_{atom} = \frac{4}{3}\pi R^3")
        
        st.markdown("""
        * $N_{atoms}$ ‚Äî –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∞—Ç–æ–º—ñ–≤, —â–æ "–Ω–∞–ª–µ–∂–∞—Ç—å" –æ–¥–Ω—ñ–π –∫–æ–º—ñ—Ä—Ü—ñ.
        * $V_{atom}$ ‚Äî –æ–±'—î–º –∞—Ç–æ–º–∞.
        * $V_{cell} = a^3$ ‚Äî –æ–±'—î–º –∫–æ–º—ñ—Ä–∫–∏.
        * –°–ø—ñ–≤–≤—ñ–¥–Ω–æ—à–µ–Ω–Ω—è –º—ñ–∂ $a$ (–ø–∞—Ä–∞–º–µ—Ç—Ä “ë—Ä–∞—Ç–∫–∏) —Ç–∞ $R$ (—Ä–∞–¥—ñ—É—Å –∞—Ç–æ–º–∞) –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —Ç–∏–ø—É “ë—Ä–∞—Ç–∫–∏.
        """)

    # --- –í–∏–±—ñ—Ä “ë—Ä–∞—Ç–∫–∏ ---
    lattice_type = st.selectbox(
        "–û–±–µ—Ä—ñ—Ç—å —Ç–∏–ø –∫—É–±—ñ—á–Ω–æ—ó “ë—Ä–∞—Ç–∫–∏:",
        ("–ü—Ä–æ—Å—Ç–∞ –∫—É–±—ñ—á–Ω–∞ (–ü–ö)", 
         "–û–±'—î–º–Ω–æ-—Ü–µ–Ω—Ç—Ä–æ–≤–∞–Ω–∞ –∫—É–±—ñ—á–Ω–∞ (–û–¶–ö)", 
         "–ì—Ä–∞ –Ω–µ-—Ü–µ–Ω—Ç—Ä–æ–≤–∞–Ω–∞ –∫—É–±—ñ—á–Ω–∞ (–ì–¶–ö)")
    )

    # --- –†–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–≤–∞ —á–∞—Å—Ç–∏–Ω–∞ ---
    viz_atoms = {
        '–ü–ö': np.array([[0,0,0], [1,0,0], [0,1,0], [0,0,1], [1,1,0], [1,0,1], [0,1,1], [1,1,1]]),
        '–û–¶–ö': np.array([[0,0,0], [1,0,0], [0,1,0], [0,0,1], [1,1,0], [1,0,1], [0,1,1], [1,1,1], [0.5,0.5,0.5]]),
        '–ì–¶–ö': np.array([[0,0,0], [1,0,0], [0,1,0], [0,0,1], [1,1,0], [1,0,1], [0,1,1], [1,1,1],
                         [0.5,0.5,0], [0.5,0.5,1], [0.5,0,0.5], [0.5,1,0.5], [0,0.5,0.5], [1,0.5,0.5]])
    }
    params = {
        '–ü–ö': {'atoms_per_cell': 1, 'coord_num': 6, 'a_R_relation': "a = 2R", 'apf_formula': r"(\frac{\pi}{6})", 'apf': (np.pi / 6)},
        '–û–¶–ö': {'atoms_per_cell': 2, 'coord_num': 8, 'a_R_relation': "a\sqrt{3} = 4R", 'apf_formula': r"(\frac{\pi\sqrt{3}}{8})", 'apf': (np.pi * np.sqrt(3) / 8)},
        '–ì–¶–ö': {'atoms_per_cell': 4, 'coord_num': 12, 'a_R_relation': "a\sqrt{2} = 4R", 'apf_formula': r"(\frac{\pi}{3\sqrt{2}})", 'apf': (np.pi / (3 * np.sqrt(2)))}
    }

    current_type = lattice_type.split(' ')[-1].strip("()")
    current_params = params[current_type]
    current_atoms = viz_atoms[current_type]

    # --- –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ ---
    st.header(f"–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –¥–ª—è: {lattice_type}")
    col1, col2, col3 = st.columns(3)
    col1.metric("–ê—Ç–æ–º—ñ–≤ –Ω–∞ –∫–æ–º—ñ—Ä–∫—É", current_params['atoms_per_cell'])
    col2.metric("–ö–æ–æ—Ä–¥–∏–Ω–∞—Ü—ñ–π–Ω–µ —á–∏—Å–ª–æ", current_params['coord_num'])
    col3.metric("–ö–æ–µ—Ñ. –ø–∞–∫—É–≤–∞–Ω–Ω—è (APF)", f"{current_params['apf'] * 100:.1f} %")

    st.subheader("–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ APF")
    # –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è: –ï–∫—Ä–∞–Ω—É—î–º–æ —Ñ—ñ–≥—É—Ä–Ω—ñ –¥—É–∂–∫–∏ —É LaTeX
    st.latex(f"a \\text{{ (–ø–∞—Ä–∞–º–µ—Ç—Ä “ë—Ä–∞—Ç–∫–∏)}}, R \\text{{ (—Ä–∞–¥—ñ—É—Å –∞—Ç–æ–º–∞)}}")
    st.latex(f"\\text{{–°–ø—ñ–≤–≤—ñ–¥–Ω–æ—à–µ–Ω–Ω—è: }} {current_params['a_R_relation']}")
    st.latex(f"APF = \\frac{{N_{{atoms}} \cdot V_{{atom}}}}{{V_{{cell}}}} \\approx {current_params['apf_formula']} \\approx {current_params['apf']:.3f}")

    # --- 3D –ì—Ä–∞—Ñ—ñ–∫ ---
    st.header("3D –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è")
    fig = go.Figure()
    fig.add_trace(go.Scatter3d(
        x=current_atoms[:, 0], y=current_atoms[:, 1], z=current_atoms[:, 2],
        mode='markers', marker=dict(color='red', size=10, symbol='circle'), name='–ê—Ç–æ–º–∏'
    ))
    
    # –î–æ–¥–∞—î–º–æ —Ä–µ–±—Ä–∞ –∫—É–±–∞
    edges = [(0,1), (1,3), (3,2), (2,0), (4,5), (5,7), (7,6), (6,4), (0,4), (1,5), (2,6), (3,7)]
    vertices = np.array([[0,0,0], [1,0,0], [0,1,0], [1,1,0], [0,0,1], [1,0,1], [0,1,1], [1,1,1]])
    for edge in edges:
        p1, p2 = vertices[edge[0]], vertices[edge[1]]
        fig.add_trace(go.Scatter3d(
            x=[p1[0], p2[0]], y=[p1[1], p2[1]], z=[p1[2], p2[2]],
            mode='lines', line=dict(color='black', width=3), showlegend=False
        ))
    
    fig.update_layout(
        title="–ï–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω–∞ –∫–æ–º—ñ—Ä–∫–∞",
        scene=dict(
            xaxis=dict(range=[-0.1, 1.1], title='a'),
            yaxis=dict(range=[-0.1, 1.1], title='b'),
            zaxis=dict(range=[-0.1, 1.1], title='c'),
            aspectratio=dict(x=1, y=1, z=1)
        ),
        margin=dict(l=0, r=0, b=0, t=40)
    )
    st.plotly_chart(fig, use_container_width=True)
