import streamlit as st
import numpy as np
import plotly.graph_objects as go

with st.container(border=True):
    st.title("üí° –°–∏–º—É–ª—è—Ç–æ—Ä –¥–æ—Å–ª—ñ–¥—É –§—Ä–∞–Ω–∫–∞-–ì–µ—Ä—Ü–∞")
    st.write("–î–µ–º–æ–Ω—Å—Ç—Ä—É—î –∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å —Å—Ç—Ä—É–º—É (I) –≤—ñ–¥ –ø—Ä–∏—Å–∫–æ—Ä—é—é—á–æ—ó –Ω–∞–ø—Ä—É–≥–∏ (V) —É —Ç—Ä—É–±—Ü—ñ –∑ –ø–∞—Ä–∞–º–∏ —Ä—Ç—É—Ç—ñ.")

    # --- –ü–ê–†–ê–ú–ï–¢–†–ò –ü–ï–†–ï–ú–Ü–©–ï–ù–û –°–Æ–î–ò ---
    st.subheader("–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ —Å–∏–º—É–ª—è—Ü—ñ—ó")
    col1, col2 = st.columns(2)
    with col1:
        V_ex_eV = st.number_input(
            "–ï–Ω–µ—Ä–≥—ñ—è –∑–±—É–¥–∂–µ–Ω–Ω—è (E_ex), –µ–í", 
            min_value=1.0, max_value=10.0, value=4.9, step=0.1,
            help="–î–ª—è —Ä—Ç—É—Ç—ñ (Hg) —Ü–µ 4.9 –µ–í.",
            key="fh_vex"
        )
    with col2:
        V_max = st.slider(
            "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –Ω–∞–ø—Ä—É–≥–∞ (V_max), –í–æ–ª—å—Ç", 
            min_value=10.0, max_value=50.0, value=30.0, step=1.0,
            key="fh_vmax"
        )
    st.divider() # –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞ –ª—ñ–Ω—ñ—è

    # --- –ë–õ–û–ö –¢–ï–û–†–Ü–á ---
    with st.expander("üìñ –í—ñ–¥–∫—Ä–∏—Ç–∏ —Ç–µ–æ—Ä—ñ—é —Ç–∞ —Ñ–æ—Ä–º—É–ª–∏", expanded=False):
        st.write("–î–æ—Å–ª—ñ–¥ –¥–æ–≤—ñ–≤, —â–æ –∞—Ç–æ–º–∏ –º–æ–∂—É—Ç—å –ø–æ–≥–ª–∏–Ω–∞—Ç–∏ –µ–Ω–µ—Ä–≥—ñ—é –ª–∏—à–µ –¥–∏—Å–∫—Ä–µ—Ç–Ω–∏–º–∏ –ø–æ—Ä—Ü—ñ—è–º–∏ (–∫–≤–∞–Ω—Ç–∞–º–∏).")
        st.markdown("""
        1.  –ï–ª–µ–∫—Ç—Ä–æ–Ω–∏ –ø—Ä–∏—Å–∫–æ—Ä—é—é—Ç—å—Å—è –Ω–∞–ø—Ä—É–≥–æ—é $V$. –á—Ö–Ω—è –∫—ñ–Ω–µ—Ç–∏—á–Ω–∞ –µ–Ω–µ—Ä–≥—ñ—è $K = e \cdot V$.
        2.  –ö–æ–ª–∏ –µ–Ω–µ—Ä–≥—ñ—è –µ–ª–µ–∫—Ç—Ä–æ–Ω–∞ –¥–æ—Å—è–≥–∞—î $4.9 \, \text{–µ–í}$ (–ø–µ—Ä—à–∏–π —Ä—ñ–≤–µ–Ω—å –∑–±—É–¥–∂–µ–Ω–Ω—è –∞—Ç–æ–º—ñ–≤ –†—Ç—É—Ç—ñ), –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è **–Ω–µ–ø—Ä—É–∂–Ω–µ –∑—ñ—Ç–∫–Ω–µ–Ω–Ω—è**.
        3.  –ï–ª–µ–∫—Ç—Ä–æ–Ω –≤—ñ–¥–¥–∞—î **–≤—Å—é** —Å–≤–æ—é –µ–Ω–µ—Ä–≥—ñ—é –∞—Ç–æ–º—É (—è–∫–∏–π –ø–æ—Ç—ñ–º –≤–∏–ø—Ä–æ–º—ñ–Ω—é—î —Ñ–æ—Ç–æ–Ω) —ñ –∑—É–ø–∏–Ω—è—î—Ç—å—Å—è.
        4.  –¶–µ–π "–∑—É–ø–∏–Ω–µ–Ω–∏–π" –µ–ª–µ–∫—Ç—Ä–æ–Ω –Ω–µ –º–æ–∂–µ –¥—ñ–π—Ç–∏ –¥–æ –∞–Ω–æ–¥–∞, —ñ **—Å—Ç—Ä—É–º $I$ —Ä—ñ–∑–∫–æ –ø–∞–¥–∞—î**.
        5.  –ü—Ä–æ—Ü–µ—Å –ø–æ–≤—Ç–æ—Ä—é—î—Ç—å—Å—è –ø—Ä–∏ –Ω–∞–ø—Ä—É–≥–∞—Ö, –∫—Ä–∞—Ç–Ω–∏—Ö $4.9 \, \text{–í}$ (–Ω–∞–ø—Ä., $9.8 \, \text{–í}$, $14.7 \, \text{–í}$...), –∫–æ–ª–∏ –µ–ª–µ–∫—Ç—Ä–æ–Ω –≤—Å—Ç–∏–≥–∞—î –∑–±—É–¥–∏—Ç–∏ –¥–≤–∞, —Ç—Ä–∏ —á–∏ –±—ñ–ª—å—à–µ –∞—Ç–æ–º—ñ–≤ –Ω–∞ —Å–≤–æ—î–º—É —à–ª—è—Ö—É.
        """)

    # --- –†–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–≤–∞ –º–æ–¥–µ–ª—å ---
    V = np.linspace(0.01, V_max, 500)
    # –°–ø—Ä–æ—â–µ–Ω–∞ –º–æ–¥–µ–ª—å, —â–æ –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î –µ—Ñ–µ–∫—Ç
    I_base = V**0.1
    I_oscillation = (V % V_ex_eV)**1.5
    I = I_base + I_oscillation / (V_ex_eV)

    # --- –ì—Ä–∞—Ñ—ñ–∫ ---
    st.header("–ì—Ä–∞—Ñ—ñ–∫ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ —Å—Ç—Ä—É–º—É –≤—ñ–¥ –Ω–∞–ø—Ä—É–≥–∏ I(V)")
    fig = go.Figure()

    fig.add_trace(go.Scatter(
        x=V, y=I, 
        mode='lines',
        name='–°—Ç—Ä—É–º (I)',
        line=dict(color='royalblue', width=3)
    ))

    peak_voltages = np.arange(V_ex_eV, V_max + V_ex_eV, V_ex_eV)
    for v_peak in peak_voltages:
        fig.add_vline(
            x=v_peak, 
            line_width=2, 
            line_dash="dash", 
            line_color="red",
            annotation_text=f"n={int(v_peak/V_ex_eV)} ({v_peak:.1f} V)",
            annotation_position="top left"
        )

    fig.update_layout(
        title="–í–æ–ª—å—Ç-–∞–º–ø–µ—Ä–Ω–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ (–í–ê–•)",
        xaxis_title="–ü—Ä–∏—Å–∫–æ—Ä—é—é—á–∞ –Ω–∞–ø—Ä—É–≥–∞ (V), –í–æ–ª—å—Ç",
        yaxis_title="–°—Ç—Ä—É–º (I), —É–º–æ–≤–Ω—ñ –æ–¥–∏–Ω–∏—Ü—ñ",
        height=500
    )
    st.plotly_chart(fig, use_container_width=True)
    st.info(f"–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —è–∫ —Å—Ç—Ä—É–º —Ä—ñ–∑–∫–æ –ø–∞–¥–∞—î **–æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è** –∫–æ–∂–Ω–æ—ó —á–µ—Ä–≤–æ–Ω–æ—ó –ª—ñ–Ω—ñ—ó (–∫—Ä–∞—Ç–Ω–∏—Ö {V_ex_eV} –í).")