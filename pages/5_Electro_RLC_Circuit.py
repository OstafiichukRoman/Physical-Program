import streamlit as st
import numpy as np
import plotly.graph_objects as go
from scipy.integrate import solve_ivp

with st.container(border=True):
    st.title("‚ö° RLC-–∫–æ–ª–æ (–ï–ª–µ–∫—Ç—Ä–∏—á–Ω–∏–π –æ—Å—Ü–∏–ª—è—Ç–æ—Ä)")
    st.write("–°–∏–º—É–ª—è—Ü—ñ—è –∑–∞—Ç—É—Ö–∞—é—á–∏—Ö –µ–ª–µ–∫—Ç—Ä–∏—á–Ω–∏—Ö –∫–æ–ª–∏–≤–∞–Ω—å —É –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ–º—É RLC-–∫–æ–Ω—Ç—É—Ä—ñ.")

    # --- –ü–ê–†–ê–úET–†–ò –°–ò–ú–£–õ–Ø–¶–Ü–á (–Ω–∞ –≥–æ–ª–æ–≤–Ω—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ) ---
    st.subheader("–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ RLC-–∫–æ–Ω—Ç—É—Ä—É")
    col1, col2, col3 = st.columns(3)
    with col1:
        L = st.slider("–Ü–Ω–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å (L), –º–ì–Ω", 1.0, 100.0, 25.0, key="rlc_L")
    with col2:
        C = st.slider("–Ñ–º–Ω—ñ—Å—Ç—å (C), –º–∫–§", 1.0, 100.0, 10.0, key="rlc_C")
    with col3:
        R = st.slider("–û–ø—ñ—Ä (R), –û–º", 0.0, 50.0, 5.0, key="rlc_R", help="R=0 - —ñ–¥–µ–∞–ª—å–Ω–∏–π –∫–æ–Ω—Ç—É—Ä, R>0 - –∑–∞—Ç—É—Ö–∞–Ω–Ω—è")

    st.subheader("–ü–æ—á–∞—Ç–∫–æ–≤—ñ —É–º–æ–≤–∏ (t=0)")
    col_q, col_i, col_t = st.columns(3)
    with col_q:
        Q0 = st.slider("–ü–æ—á–∞—Ç–∫–æ–≤–∏–π –∑–∞—Ä—è–¥ (Q‚ÇÄ), –º–∫–ö–ª", 0.0, 100.0, 50.0, key="rlc_Q0")
    with col_i:
        I0 = st.slider("–ü–æ—á–∞—Ç–∫–æ–≤–∏–π —Å—Ç—Ä—É–º (I‚ÇÄ), –ê", 0.0, 1.0, 0.0, key="rlc_I0")
    with col_t:
        t_max_ms = st.slider("–ß–∞—Å —Å–∏–º—É–ª—è—Ü—ñ—ó (T), –º—Å", 1.0, 100.0, 30.0, key="rlc_tmax")
    
    st.divider() # –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞ –ª—ñ–Ω—ñ—è

    # --- –ë–õ–û–ö –¢–ï–û–†–Ü–á ---
    with st.expander("üìñ –í—ñ–¥–∫—Ä–∏—Ç–∏ —Ç–µ–æ—Ä—ñ—é, —Ñ–æ—Ä–º—É–ª–∏ —Ç–∞ –∞–Ω–∞–ª–æ–≥—ñ—ó", expanded=False):
        st.subheader("–î–∏—Ñ–µ—Ä–µ–Ω—Ü—ñ–∞–ª—å–Ω–µ —Ä—ñ–≤–Ω—è–Ω–Ω—è RLC-–∫–æ–Ω—Ç—É—Ä—É")
        st.write("–ó–∞ 2-–º –ø—Ä–∞–≤–∏–ª–æ–º –ö—ñ—Ä—Ö–≥–æ—Ñ–∞ (—Å—É–º–∞ –Ω–∞–ø—Ä—É–≥ = 0):")
        st.latex(r"L \frac{dI}{dt} + R I + \frac{Q}{C} = 0")
        st.write("–û—Å–∫—ñ–ª—å–∫–∏ $I = dQ/dt$, –º–∏ –æ—Ç—Ä–∏–º—É—î–º–æ –î–† –¥—Ä—É–≥–æ–≥–æ –ø–æ—Ä—è–¥–∫—É –¥–ª—è –∑–∞—Ä—è–¥—É $Q(t)$:")
        st.latex(r"L \frac{d^2Q}{dt^2} + R \frac{dQ}{dt} + \frac{1}{C} Q = 0")
        
        st.subheader("–ú–µ—Ö–∞–Ω—ñ—á–Ω–∞ –∞–Ω–∞–ª–æ–≥—ñ—è (–û—Å—Ü–∏–ª—è—Ç–æ—Ä)")
        st.write("–¶–µ —Ä—ñ–≤–Ω—è–Ω–Ω—è **–º–∞—Ç–µ–º–∞—Ç–∏—á–Ω–æ —ñ–¥–µ–Ω—Ç–∏—á–Ω–µ** —Ä—ñ–≤–Ω—è–Ω–Ω—é –∑–∞—Ç—É—Ö–∞—é—á–æ–≥–æ –º–µ—Ö–∞–Ω—ñ—á–Ω–æ–≥–æ –æ—Å—Ü–∏–ª—è—Ç–æ—Ä–∞:")
        st.latex(r"m \ddot{x} + b \dot{x} + k x = 0")
        st.write("–î–µ —ñ—Å–Ω—É—é—Ç—å –ø—Ä—è–º—ñ –∞–Ω–∞–ª–æ–≥–∏:")
        st.markdown("""
        * **–ó–∞—Ä—è–¥ ($Q$)** $\leftrightarrow$ **–ó–º—ñ—â–µ–Ω–Ω—è ($x$)**
        * **–°—Ç—Ä—É–º ($I$)** $\leftrightarrow$ **–®–≤–∏–¥–∫—ñ—Å—Ç—å ($v$)**
        * **–Ü–Ω–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å ($L$)** $\leftrightarrow$ **–ú–∞—Å–∞ ($m$)** (—ñ–Ω–µ—Ä—Ü—ñ—è —Å–∏—Å—Ç–µ–º–∏)
        * **–û–ø—ñ—Ä ($R$)** $\leftrightarrow$ **–¢–µ—Ä—Ç—é ($b$)** (–≤—Ç—Ä–∞—Ç–∏ –µ–Ω–µ—Ä–≥—ñ—ó)
        * **–û–±–µ—Ä–Ω–µ–Ω–∞ —î–º–Ω—ñ—Å—Ç—å ($1/C$)** $\leftrightarrow$ **–ñ–æ—Ä—Å—Ç–∫—ñ—Å—Ç—å ($k$)** (–ø–æ–≤–µ—Ä—Ç–∞—é—á–∞ —Å–∏–ª–∞)
        """)

    # --- –†–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–≤–∞ —á–∞—Å—Ç–∏–Ω–∞ ---
    
    # –ü–µ—Ä–µ–≤–æ–¥–∏–º–æ –≤ –°–Ü
    L_si = L * 1e-3 # –º–ì–Ω -> –ì–Ω
    C_si = C * 1e-6 # –º–∫–§ -> –§
    Q0_si = Q0 * 1e-6 # –º–∫–ö–ª -> –ö–ª
    t_max_si = t_max_ms * 1e-3 # –º—Å -> —Å
    
    # –°–∏—Å—Ç–µ–º–∞ –î–†:
    # y[0] = Q (–∑–∞—Ä—è–¥)
    # y[1] = I (—Å—Ç—Ä—É–º)
    # dQ/dt = I                 => y[0]' = y[1]
    # dI/dt = (-R*I - Q/C) / L  => y[1]' = (-R*y[1] - y[0]/C) / L
    def model(t, y):
        Q, I = y
        dQdt = I
        dIdt = (-R * I - Q / C_si) / L_si
        return [dQdt, dIdt]

    y0_state = [Q0_si, I0]
    t_span = [0, t_max_si]
    t_eval = np.linspace(t_span[0], t_span[1], 1000)

    sol = solve_ivp(model, t_span, y0_state, t_eval=t_eval, method='RK45')
    
    t_plot_ms = sol.t * 1000 # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –≤ –º—Å –¥–ª—è –≥—Ä–∞—Ñ—ñ–∫–∞
    Q_plot_uC = sol.y[0] * 1e6 # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –≤ –º–∫–ö–ª
    I_plot_A = sol.y[1]

    # --- –ì—Ä–∞—Ñ—ñ–∫–∏ ---
    st.header("–ì—Ä–∞—Ñ—ñ–∫–∏ –∫–æ–ª–∏–≤–∞–Ω—å")
    
    tab1, tab2 = st.tabs(["–ó–∞—Ä—è–¥ –Ω–∞ –∫–æ–Ω–¥–µ–Ω—Å–∞—Ç–æ—Ä—ñ Q(t)", "–°—Ç—Ä—É–º —É –∫–æ–Ω—Ç—É—Ä—ñ I(t)"])

    with tab1:
        fig1 = go.Figure()
        fig1.add_trace(go.Scatter(
            x=t_plot_ms, y=Q_plot_uC,
            mode='lines', name='–ó–∞—Ä—è–¥ Q(t)',
            line=dict(color='blue', width=3)
        ))
        fig1.update_layout(
            title="–ó–∞–ª–µ–∂–Ω—ñ—Å—Ç—å –∑–∞—Ä—è–¥—É –Ω–∞ –∫–æ–Ω–¥–µ–Ω—Å–∞—Ç–æ—Ä—ñ –≤—ñ–¥ —á–∞—Å—É",
            xaxis_title="–ß–∞—Å (t), –º—Å",
            yaxis_title="–ó–∞—Ä—è–¥ (Q), –º–∫–ö–ª"
        )
        st.plotly_chart(fig1, use_container_width=True)

    with tab2:
        fig2 = go.Figure()
        fig2.add_trace(go.Scatter(
            x=t_plot_ms, y=I_plot_A,
            mode='lines', name='–°—Ç—Ä—É–º I(t)',
            line=dict(color='red', width=3)
        ))
        fig2.update_layout(
            title="–ó–∞–ª–µ–∂–Ω—ñ—Å—Ç—å —Å—Ç—Ä—É–º—É –≤ –∫–æ–Ω—Ç—É—Ä—ñ –≤—ñ–¥ —á–∞—Å—É",
            xaxis_title="–ß–∞—Å (t), –º—Å",
            yaxis_title="–°—Ç—Ä—É–º (I), –ê–º–ø–µ—Ä"
        )
        st.plotly_chart(fig2, use_container_width=True)

    st.info("–°–ø—Ä–æ–±—É–π—Ç–µ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ $R=0$ (—ñ–¥–µ–∞–ª—å–Ω–∏–π –∫–æ–Ω—Ç—É—Ä) —ñ –ø–æ–¥–∏–≤—ñ—Ç—å—Å—è –Ω–∞ –Ω–µ–∑–∞—Ç—É—Ö–∞—é—á—ñ –∫–æ–ª–∏–≤–∞–Ω–Ω—è. –ó–±—ñ–ª—å—à—É—é—á–∏ $R$, –≤–∏ –ø–æ–±–∞—á–∏—Ç–µ, —è–∫ –∫–æ–ª–∏–≤–∞–Ω–Ω—è —à–≤–∏–¥–∫–æ –∑–≥–∞—Å–∞—é—Ç—å.")