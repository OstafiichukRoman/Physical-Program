import streamlit as st
import numpy as np
import plotly.graph_objects as go

# --- –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–æ–≤–∂–∏–Ω–∏ —Ö–≤–∏–ª—ñ (–Ω–º) —É –∫–æ–ª—ñ—Ä (HEX) –¥–ª—è –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó ---
def wavelength_to_hex(nm):
    gamma = 0.8
    intensity_max = 255
    factor = 0.0
    R, G, B = 0, 0, 0

    if 380 <= nm <= 439:
        R = -(nm - 440) / (440 - 380)
        G = 0.0
        B = 1.0
    elif 440 <= nm <= 489:
        R = 0.0
        G = (nm - 440) / (490 - 440)
        B = 1.0
    elif 490 <= nm <= 509:
        R = 0.0
        G = 1.0
        B = -(nm - 510) / (510 - 490)
    elif 510 <= nm <= 579:
        R = (nm - 510) / (580 - 510)
        G = 1.0
        B = 0.0
    elif 580 <= nm <= 644:
        R = 1.0
        G = -(nm - 645) / (645 - 580)
        B = 0.0
    elif 645 <= nm <= 780:
        R = 1.0
        G = 0.0
        B = 0.0

    if 380 <= nm <= 419:
        factor = 0.3 + 0.7 * (nm - 380) / (420 - 380)
    elif 420 <= nm <= 644:
        factor = 1.0
    elif 645 <= nm <= 780:
        factor = 0.3 + 0.7 * (780 - nm) / (780 - 645)
    else:
        factor = 0.0

    R = int(intensity_max * (R * factor)**gamma)
    G = int(intensity_max * (G * factor)**gamma)
    B = int(intensity_max * (B * factor)**gamma)
    
    return f'#{R:02x}{G:02x}{B:02x}'

# --- –û—Å–Ω–æ–≤–Ω–∞ —á–∞—Å—Ç–∏–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–∏ ---
with st.container(border=True):
    st.title("üåä –Ü–Ω—Ç–µ—Ä—Ñ–µ—Ä–µ–Ω—Ü—ñ—è –Ω–∞ –¥–≤–æ—Ö —â—ñ–ª–∏–Ω–∞—Ö (–î–æ—Å–ª—ñ–¥ –Æ–Ω–≥–∞)")
    st.write("–°–∏–º—É–ª—è—Ü—ñ—è –ø–æ–∫–∞–∑—É—î, —è–∫ —Å–≤—ñ—Ç–ª–æ, –ø—Ä–æ—Ö–æ–¥—è—á–∏ —á–µ—Ä–µ–∑ –¥–≤—ñ —â—ñ–ª–∏–Ω–∏, —Å—Ç–≤–æ—Ä—é—î —ñ–Ω—Ç–µ—Ä—Ñ–µ—Ä–µ–Ω—Ü—ñ–π–Ω—É –∫–∞—Ä—Ç–∏–Ω—É –Ω–∞ –µ–∫—Ä–∞–Ω—ñ.")

    # --- –ü–ê–†–ê–ú–ï–¢–†–ò –°–ò–ú–£–õ–Ø–¶–Ü–á (–Ω–∞ –≥–æ–ª–æ–≤–Ω—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ) ---
    st.subheader("–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ —Å–∏–º—É–ª—è—Ü—ñ—ó")
    col1, col2, col3 = st.columns(3)

    with col1:
        lambda_nm = st.slider(
            "–î–æ–≤–∂–∏–Ω–∞ —Ö–≤–∏–ª—ñ (Œª), –Ω–º", 
            min_value=400, max_value=700, value=550, step=10,
            key="young_lambda", help="–í—ñ–¥ —Ñ—ñ–æ–ª–µ—Ç–æ–≤–æ–≥–æ (400 –Ω–º) –¥–æ —á–µ—Ä–≤–æ–Ω–æ–≥–æ (700 –Ω–º)")
        
        # –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –æ–±—Ä–∞–Ω–æ–≥–æ –∫–æ–ª—å–æ—Ä—É
        color_hex = wavelength_to_hex(lambda_nm)
        st.markdown(f"**–û–±—Ä–∞–Ω–∏–π –∫–æ–ª—ñ—Ä:** <div style='width:100%; height:20px; background-color:{color_hex}; border: 1px solid white;'></div>", unsafe_allow_html=True)

    with col2:
        d_um = st.slider(
            "–í—ñ–¥—Å—Ç–∞–Ω—å –º—ñ–∂ —â—ñ–ª–∏–Ω–∞–º–∏ (d), –º–∫–º", 
            min_value=1, max_value=500, value=150, step=1,
            key="young_d", help="–ú—ñ–∫—Ä–æ–º–µ—Ç—Ä–∏ (10‚Åª‚Å∂ –º)")

    with col3:
        L_m = st.slider(
            "–í—ñ–¥—Å—Ç–∞–Ω—å –¥–æ –µ–∫—Ä–∞–Ω–∞ (L), –º", 
            min_value=0.5, max_value=5.0, value=2.0, step=0.1,
            key="young_L")

    st.divider()

    # --- –ë–õ–û–ö –¢–ï–û–†–Ü–á ---
    with st.expander("üìñ –í—ñ–¥–∫—Ä–∏—Ç–∏ —Ç–µ–æ—Ä—ñ—é —Ç–∞ —Ñ–æ—Ä–º—É–ª–∏", expanded=False):
        st.subheader("–£–º–æ–≤–∏ –º–∞–∫—Å–∏–º—É–º—ñ–≤ —Ç–∞ –º—ñ–Ω—ñ–º—É–º—ñ–≤")
        st.write("–Ü–Ω—Ç–µ—Ä—Ñ–µ—Ä–µ–Ω—Ü—ñ–π–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∞ –≤–∏–Ω–∏–∫–∞—î —á–µ—Ä–µ–∑ —Ä—ñ–∑–Ω–∏—Ü—é —Ö–æ–¥—É —Ö–≤–∏–ª—å ($\Delta x$) –≤—ñ–¥ –¥–≤–æ—Ö —â—ñ–ª–∏–Ω –¥–æ —Ç–æ—á–∫–∏ $y$ –Ω–∞ –µ–∫—Ä–∞–Ω—ñ.")
        st.latex(r"\Delta x \approx \frac{d \cdot y}{L}")
        
        # --- –û–°–¨ –¢–£–¢ –ë–£–õ–ê –ü–û–ú–ò–õ–ö–ê, –¢–ï–ü–ï–† –í–ò–ü–†–ê–í–õ–ï–ù–û ---
        # (–§–æ—Ä–º—É–ª–∏ –≤–∏–Ω–µ—Å–µ–Ω–æ –∑ st.markdown –≤ st.latex)
        
        st.markdown("* **–ú–∞–∫—Å–∏–º—É–º–∏ (—Å–≤—ñ—Ç–ª—ñ —Å–º—É–≥–∏):** –†—ñ–∑–Ω–∏—Ü—è —Ö–æ–¥—É –¥–æ—Ä—ñ–≤–Ω—é—î —Ü—ñ–ª–æ–º—É —á–∏—Å–ª—É –¥–æ–≤–∂–∏–Ω —Ö–≤–∏–ª—å.")
        st.latex(r"d \sin(\theta) \approx \frac{d \cdot y}{L} = m\lambda \quad (m = 0, \pm 1, \pm 2...)")
        
        st.markdown("* **–ú—ñ–Ω—ñ–º—É–º–∏ (—Ç–µ–º–Ω—ñ —Å–º—É–≥–∏):** –†—ñ–∑–Ω–∏—Ü—è —Ö–æ–¥—É –¥–æ—Ä—ñ–≤–Ω—é—î –Ω–∞–ø—ñ–≤—Ü—ñ–ª–æ–º—É —á–∏—Å–ª—É –¥–æ–≤–∂–∏–Ω —Ö–≤–∏–ª—å.")
        st.latex(r"d \sin(\theta) \approx \frac{d \cdot y}{L} = \left(m + \frac{1}{2}\right)\lambda")
        # --- –ö–Ü–ù–ï–¶–¨ –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø ---

        st.subheader("–Ü–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ñ—Å—Ç—å")
        st.write("–Ü–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ñ—Å—Ç—å $I$ –≤ —Ç–æ—á—Ü—ñ $y$ –Ω–∞ –µ–∫—Ä–∞–Ω—ñ (—É –Ω–∞–±–ª–∏–∂–µ–Ω–Ω—ñ –º–∞–ª–∏—Ö –∫—É—Ç—ñ–≤):")
        st.latex(r"I(y) = I_0 \cos^2\left(\frac{\phi}{2}\right) \quad \text{–¥–µ} \quad \phi = \frac{2\pi d y}{\lambda L}")

    # --- –†–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–≤–∞ —á–∞—Å—Ç–∏–Ω–∞ ---
    
    # –ü–µ—Ä–µ–≤–æ–¥–∏–º–æ –≤—Å—ñ –æ–¥–∏–Ω–∏—Ü—ñ –≤ –°–Ü (–º–µ—Ç—Ä–∏)
    lambda_m = lambda_nm * 1e-9
    d_m = d_um * 1e-6

    # –†–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ —à–∏—Ä–∏–Ω—É –µ–∫—Ä–∞–Ω–∞ –¥–ª—è –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó (–Ω–∞–ø—Ä., 5 —Å–º –≤ –∫–æ–∂–Ω—É —Å—Ç–æ—Ä–æ–Ω—É)
    y_max_m = 0.05 
    y = np.linspace(-y_max_m, y_max_m, 1000) # 1000 —Ç–æ—á–æ–∫ –Ω–∞ –µ–∫—Ä–∞–Ω—ñ

    # –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Ñ–∞–∑–æ–≤–æ–≥–æ –∑—Å—É–≤—É (phi)
    phi = (2 * np.pi * d_m * y) / (lambda_m * L_m)
    
    # –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —ñ–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—ñ (–Ω–æ—Ä–º–æ–≤–∞–Ω–∞ –¥–æ 1)
    Intensity = np.cos(phi / 2)**2
    
    # –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –≤—ñ–¥—Å—Ç–∞–Ω—ñ –º—ñ–∂ –º–∞–∫—Å–∏–º—É–º–∞–º–∏
    delta_y = (lambda_m * L_m) / d_m
    delta_y_mm = delta_y * 1000 # –ü–µ—Ä–µ–≤–æ–¥–∏–º–æ –≤ –º—ñ–ª—ñ–º–µ—Ç—Ä–∏

    st.header("–†–µ–∑—É–ª—å—Ç–∞—Ç–∏")
    st.metric("–í—ñ–¥—Å—Ç–∞–Ω—å –º—ñ–∂ —Å–º—É–≥–∞–º–∏ (Œîy)", f"{delta_y_mm:.2f} –º–º")

    # --- –ì—Ä–∞—Ñ—ñ–∫ ---
    st.header("–Ü–Ω—Ç–µ—Ä—Ñ–µ—Ä–µ–Ω—Ü—ñ–π–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∞ –Ω–∞ –µ–∫—Ä–∞–Ω—ñ")

    fig = go.Figure()
    fig.add_trace(go.Scatter(
        x=y * 1000, # –ü–µ—Ä–µ–≤–æ–¥–∏–º–æ –≤ –º–º –¥–ª—è –≥—Ä–∞—Ñ—ñ–∫–∞
        y=Intensity,
        mode='lines',
        name='–Ü–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ñ—Å—Ç—å',
        line=dict(color=color_hex, width=4)
    ))
    
    fig.update_layout(
        title="–†–æ–∑–ø–æ–¥—ñ–ª —ñ–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—ñ —Å–≤—ñ—Ç–ª–∞ –Ω–∞ –µ–∫—Ä–∞–Ω—ñ",
        xaxis_title="–ü–æ–∑–∏—Ü—ñ—è –Ω–∞ –µ–∫—Ä–∞–Ω—ñ (y), –º–º",
        yaxis_title="–Ü–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ñ—Å—Ç—å (I/I_max)",
        height=400
    )
    st.plotly_chart(fig, use_container_width=True)