import streamlit as st
import numpy as np
import plotly.graph_objects as go
from scipy.signal import square, sawtooth

with st.container(border=True):
    st.title("üßÆ –°–∏–Ω—Ç–µ–∑ –§—É—Ä'—î (–ü–æ–±—É–¥–æ–≤–∞ –•–≤–∏–ª—ñ)")
    st.write("–°–∏–º—É–ª—è—Ü—ñ—è –ø–æ–∫–∞–∑—É—î, —è–∫ –±—É–¥—å-—è–∫—É –ø–µ—Ä—ñ–æ–¥–∏—á–Ω—É —Ö–≤–∏–ª—é –º–æ–∂–Ω–∞ '–ø–æ–±—É–¥—É–≤–∞—Ç–∏' –∑ —Å—É–º–∏ –ø—Ä–æ—Å—Ç–∏—Ö —Å–∏–Ω—É—Å–æ—ó–¥ (–≥–∞—Ä–º–æ–Ω—ñ–∫).")

    # --- –ü–ê–†–ê–ú–ï–¢–†–ò –°–ò–ú–£–õ–Ø–¶–Ü–á (–Ω–∞ –≥–æ–ª–æ–≤–Ω—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ) ---
    st.subheader("–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ —Å–∏–º—É–ª—è—Ü—ñ—ó")
    
    col1, col2 = st.columns(2)
    with col1:
        wave_type = st.radio(
            "–û–±–µ—Ä—ñ—Ç—å —Ç–∏–ø —Ö–≤–∏–ª—ñ:",
            ("–ö–≤–∞–¥—Ä–∞—Ç–Ω–∞ (–º–µ–∞–Ω–¥—Ä)", "–ü–∏–ª–∫–æ–ø–æ–¥—ñ–±–Ω–∞"),
            key="fourier_wave_type", horizontal=True
        )
    with col2:
        N_harmonics = st.slider(
            "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≥–∞—Ä–º–æ–Ω—ñ–∫ (N)",
            min_value=1, max_value=100, value=3, step=1,
            key="fourier_n", help="–°–ø—Ä–æ–±—É–π—Ç–µ N=1, N=3, N=5... N=100"
        )
    
    st.divider()

    # --- –ë–õ–û–ö –¢–ï–û–†–Ü–á (–∑ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–∏–º LaTeX) ---
    with st.expander("üìñ –í—ñ–¥–∫—Ä–∏—Ç–∏ —Ç–µ–æ—Ä—ñ—é —Ç–∞ —Ñ–æ—Ä–º—É–ª–∏", expanded=False):
        st.subheader("–†—è–¥ –§—É—Ä'—î")
        st.write("–¢–µ–æ—Ä–µ–º–∞ –§—É—Ä'—î —Å—Ç–≤–µ—Ä–¥–∂—É—î, —â–æ –±—É–¥—å-—è–∫—É –ø–µ—Ä—ñ–æ–¥–∏—á–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é $f(x)$ –º–æ–∂–Ω–∞ –ø–æ–¥–∞—Ç–∏ —É –≤–∏–≥–ª—è–¥—ñ –Ω–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω–æ—ó —Å—É–º–∏ —Å–∏–Ω—É—Å—ñ–≤ —ñ –∫–æ—Å–∏–Ω—É—Å—ñ–≤:")
        st.latex("f(x) = \\frac{a_0}{2} + \sum_{n=1}^{\infty} \\left( a_n \cos(nx) + b_n \sin(nx) \\right)")
        
        st.subheader("–ö–≤–∞–¥—Ä–∞—Ç–Ω–∞ —Ö–≤–∏–ª—è (–º–µ–∞–Ω–¥—Ä)")
        st.write("–î–ª—è –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ—ó —Ö–≤–∏–ª—ñ —Ä—è–¥ —Å–∫–ª–∞–¥–∞—î—Ç—å—Å—è –ª–∏—à–µ –∑ –Ω–µ–ø–∞—Ä–Ω–∏—Ö —Å–∏–Ω—É—Å—ñ–≤:")
        st.latex("f(x) = \\frac{4}{\\pi} \sum_{n=1, 3, 5...}^{\infty} \\frac{\\sin(nx)}{n}")
        
        st.subheader("–ü–∏–ª–∫–æ–ø–æ–¥—ñ–±–Ω–∞ —Ö–≤–∏–ª—è")
        st.write("–î–ª—è –ø–∏–ª–∫–æ–ø–æ–¥—ñ–±–Ω–æ—ó —Ö–≤–∏–ª—ñ —Ä—è–¥ —Å–∫–ª–∞–¥–∞—î—Ç—å—Å—è –∑ —É—Å—ñ—Ö —Å–∏–Ω—É—Å—ñ–≤:")
        st.latex("f(x) = \\frac{2}{\\pi} \sum_{n=1}^{\infty} (-1)^{n+1} \\frac{\sin(nx)}{n}")
        st.info("–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —è–∫ –ø—Ä–∏ –∑–±—ñ–ª—å—à–µ–Ω–Ω—ñ N –Ω–∞ –∫—Ä–∞—è—Ö –∑'—è–≤–ª—è—î—Ç—å—Å—è \"–¥–∑–≤—ñ–Ω\" - —Ü–µ –Ω–∞–∑–∏–≤–∞—î—Ç—å—Å—è —è–≤–∏—â–µ–º –ì—ñ–±–±—Å–∞.")

    # --- –†–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–≤–∞ —á–∞—Å—Ç–∏–Ω–∞ ---
    
    # –°—Ç–≤–æ—Ä—é—î–º–æ —Å—ñ—Ç–∫—É
    x = np.linspace(-2 * np.pi, 2 * np.pi, 2000)
    y_sum = np.zeros_like(x)
    
    if wave_type == "–ö–≤–∞–¥—Ä–∞—Ç–Ω–∞ (–º–µ–∞–Ω–¥—Ä)":
        # –Ü–¥–µ–∞–ª—å–Ω–∞ —Ö–≤–∏–ª—è –¥–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è
        y_ideal = (4/np.pi) * square(x)
        
        # –†–∞—Ö—É—î–º–æ —Å—É–º—É N –≥–∞—Ä–º–æ–Ω—ñ–∫
        for n_odd in range(1, N_harmonics * 2, 2): # 1, 3, 5...
            term = (4 / np.pi) * (np.sin(n_odd * x) / n_odd)
            y_sum += term
            
    elif wave_type == "–ü–∏–ª–∫–æ–ø–æ–¥—ñ–±–Ω–∞":
        # –Ü–¥–µ–∞–ª—å–Ω–∞ —Ö–≤–∏–ª—è –¥–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è
        y_ideal = (2/np.pi) * sawtooth(x + np.pi) # +pi, —â–æ–± –∑—Å—É–Ω—É—Ç–∏
        
        # –†–∞—Ö—É—î–º–æ —Å—É–º—É N –≥–∞—Ä–º–æ–Ω—ñ–∫
        for n in range(1, N_harmonics + 1):
            term = (2 / np.pi) * ((-1)**(n+1)) * (np.sin(n * x) / n)
            y_sum += term

    # --- –ì—Ä–∞—Ñ—ñ–∫ ---
    st.header(f"–ü–æ–±—É–¥–æ–≤–∞ —Ö–≤–∏–ª—ñ –∑ N = {N_harmonics} –≥–∞—Ä–º–æ–Ω—ñ–∫")
    
    fig = go.Figure()

    # 1. –ú–∞–ª—é—î–º–æ —ñ–¥–µ–∞–ª—å–Ω—É —Ö–≤–∏–ª—é (—Å—ñ—Ä–∏–º –ø—É–Ω–∫—Ç–∏—Ä–æ–º)
    fig.add_trace(go.Scatter(
        x=x, 
        y=y_ideal,
        mode='lines',
        name='–Ü–¥–µ–∞–ª—å–Ω–∞ —Ö–≤–∏–ª—è',
        line=dict(color='gray', width=2, dash='dot')
    ))

    # 2. –ú–∞–ª—é—î–º–æ –Ω–∞—à—É —Å—É–º—É –§—É—Ä'—î (—á–µ—Ä–≤–æ–Ω–∏–º)
    fig.add_trace(go.Scatter(
        x=x, 
        y=y_sum,
        mode='lines',
        name=f'–°—É–º–∞ N={N_harmonics} –≥–∞—Ä–º–æ–Ω—ñ–∫',
        line=dict(color='red', width=3)
    ))

    fig.update_layout(
        title=f"–°–∏–Ω—Ç–µ–∑ –§—É—Ä'—î –¥–ª—è '{wave_type}'",
        xaxis_title="x (—Ä–∞–¥—ñ–∞–Ω–∏)",
        yaxis_title="–ê–º–ø–ª—ñ—Ç—É–¥–∞ f(x)",
        xaxis=dict(tickvals=[-2*np.pi, -np.pi, 0, np.pi, 2*np.pi], 
                   ticktext=['-2œÄ', '-œÄ', '0', 'œÄ', '2œÄ']),
        height=500
    )
    st.plotly_chart(fig, use_container_width=True)